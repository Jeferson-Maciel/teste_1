<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Leads</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
    background: #0b0f1a;
    color: #fff;
    margin: 0;
    padding: 20px;
}

.container { max-width: 1100px; margin: auto; }

.card {
    background: #11162a;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 0 25px rgba(0,255,255,.15);
    margin-bottom: 25px;
    animation: fade .4s ease;
}

@keyframes fade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes removeRow {
    to { opacity: 0; transform: translateX(-20px); height: 0; }
}

input, button {
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
}

input {
    background: #0b0f1a;
    color: #fff;
    border: 1px solid #00f7ff55;
}

button {
    cursor: pointer;
    background: linear-gradient(135deg, #00f7ff, #00c4cc);
    font-weight: 600;
}

button:hover { box-shadow: 0 0 15px #00f7ff; }

.reset {
    background: #ff3b3b;
    margin-bottom: 10px;
}

.form { display: flex; gap: 10px; flex-wrap: wrap; }

.rankings {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(300px,1fr));
    gap: 20px;
}

table { width: 100%; border-collapse: collapse; }
td { padding: 10px; }
tr { border-bottom: 1px solid #ffffff15; }

.remove {
    background: #ff3b3b;
    color: #fff;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
}

.editable { cursor: pointer; }

.top1 td { color: gold; }
.top2 td { color: silver; }
.top3 td { color: #cd7f32; }
</style>
</head>

<body>
<div class="container">

<div class="card">
    <h2>Adicionar Lead</h2>
    <div class="form">
        <input id="nome" placeholder="Nome do Lead">
        <input id="qtd" type="number" placeholder="Quantidade">
        <button id="btnAdd">Adicionar</button>
    </div>
</div>

<div class="rankings">

<div class="card">
    <h3>üèÜ Ranking Di√°rio</h3>
    <button class="reset" onclick="resetar('dia')">Resetar</button>
    <table><tbody id="rankingDia"></tbody></table>
</div>

<div class="card">
    <h3>üî• Ranking Semanal</h3>
    <button class="reset" onclick="resetar('semana')">Resetar</button>
    <table><tbody id="rankingSemana"></tbody></table>
</div>

<div class="card">
    <h3>üìÖ Ranking Mensal</h3>
    <button class="reset" onclick="resetar('mes')">Resetar</button>
    <table><tbody id="rankingMes"></tbody></table>
</div>

</div>
</div>

<script>
const supabaseClient = supabase.createClient(
  "https://ugyybmztaoopyetyrsit.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVneXlibXp0YW9vcHlldHlyc2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTczNDQsImV4cCI6MjA4Mzg5MzM0NH0.dLtrsK7XQNwM1DGMo-vv8llqZT5ajLKByfZIKLMOwgg"
);

const nomeInput = document.getElementById("nome");
const qtdInput = document.getElementById("qtd");

document.getElementById("btnAdd").onclick = adicionar;

async function adicionar() {
    const nome = nomeInput.value.trim();
    const qtd = Number(qtdInput.value);

    if (!nome || qtd <= 0) return alert("Preencha corretamente");

    const { data, error } = await supabaseClient
        .from("ranking")
        .select("*")
        .eq("nome", nome)
        .maybeSingle();

    if (error) return alert("Erro ao buscar lead");

    if (data) {
        await supabaseClient.from("ranking").update({
            leads_dia: (data.leads_dia || 0) + qtd,
            leads_semana: (data.leads_semana || 0) + qtd,
            leads_mes: (data.leads_mes || 0) + qtd
        }).eq("id", data.id);
    } else {
        await supabaseClient.from("ranking").insert({
            nome,
            leads_dia: qtd,
            leads_semana: qtd,
            leads_mes: qtd
        });
    }

    nomeInput.value = "";
    qtdInput.value = "";
    carregar();
}

function linha(p, i, campo) {
    const medalha = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
    return `
    <tr data-id="${p.id}" class="${i < 3 ? `top${i+1}` : ""}">
        <td>${medalha} ${i + 1}</td>
        <td contenteditable class="editable">${p.nome}</td>
        <td>${p[campo] || 0}</td>
        <td><button class="remove">X</button></td>
    </tr>`;
}

async function carregar() {
    const { data } = await supabaseClient.from("ranking").select("*");
    if (!data) return;

    render("Dia", "leads_dia", data);
    render("Semana", "leads_semana", data);
    render("Mes", "leads_mes", data);
}

function render(tipo, campo, data) {
    document.getElementById("ranking" + tipo).innerHTML =
        [...data]
        .sort((a, b) => (b[campo] || 0) - (a[campo] || 0))
        .map((p, i) => linha(p, i, campo))
        .join("");
}

async function resetar(tipo) {
    if (!confirm("Deseja resetar este ranking?")) return;

    const rpcMap = {
        dia: "resetar_ranking_dia",
        semana: "resetar_ranking_semana",
        mes: "resetar_ranking_mes"
    };

    const { error } = await supabaseClient.rpc(rpcMap[tipo], {});

    if (error) {
        console.error(error);
        alert("Erro ao resetar ranking");
        return;
    }

    carregar();
}


document.addEventListener("click", async e => {
    if (e.target.classList.contains("remove")) {
        const tr = e.target.closest("tr");
        const id = tr.dataset.id;

        tr.style.animation = "removeRow .3s forwards";
        setTimeout(async () => {
            await supabaseClient.from("ranking").delete().eq("id", id);
            carregar();
        }, 300);
    }
});

document.addEventListener("blur", async e => {
    if (e.target.classList.contains("editable")) {
        const tr = e.target.closest("tr");
        const id = tr.dataset.id;
        await supabaseClient.from("ranking")
            .update({ nome: e.target.innerText.trim() })
            .eq("id", id);
        carregar();
    }
}, true);

carregar();
</script>
</body>
</html>
