<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RANKING ARG</title>

<link rel="icon" href="favicon.ico" sizes="any">
<link rel="icon" href="logo.png" type="image/png">
<link rel="apple-touch-icon" href="logo.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================
   DESIGN MAIS FORMAL (SEM MUDAR FUNCIONALIDADES)
   ========================= */
:root{
  --bg:#0b1220;
  --bg2:#0a1222;
  --surface:#101a2e;
  --surface2:#0f182a;
  --border:rgba(255,255,255,.12);  /* acessibilidade: um pouco mais vis√≠vel */
  --border2:rgba(255,255,255,.10); /* acessibilidade: um pouco mais vis√≠vel */
  --text:#eef2ff;
  --muted:rgba(238,242,255,.78);   /* acessibilidade: melhora contraste */
  --muted2:rgba(238,242,255,.60);  /* acessibilidade: melhora contraste */

  --accent:#3b82f6;
  --accent2:#2563eb;
  --danger:#ef4444;

  --shadow:0 10px 26px rgba(0,0,0,.34);
  --radius:14px;
  --radius2:12px;
}

*{ box-sizing:border-box; font-family:'Inter',sans-serif; }
html,body{ height:100%; }

/* ‚úÖ acessibilidade: tipografia responsiva e foco vis√≠vel */
body{
  margin:0;
  padding:18px;
  color:var(--text);
  min-height:100vh;
  font-size:clamp(13px, 1.05vw, 14px);
  line-height:1.35;

  /* fundo base s√≥lido (n√£o ‚Äúacaba‚Äù ao rolar) */
  background-color: #0b1220;

  /* gradiente profissional + moderno (infinito) */
  background-image:
    radial-gradient(1200px 700px at 18% -10%, rgba(59,130,246,.18), transparent 60%),
    radial-gradient(900px 520px at 95% 10%, rgba(34,211,238,.10), transparent 55%),
    radial-gradient(1000px 600px at 50% 115%, rgba(99,102,241,.12), transparent 60%),
    linear-gradient(180deg, #0b1220 0%, #0a1222 100%);

  /* ‚Äúinfinito‚Äù: fixa no viewport, n√£o repete por altura da p√°gina */
  background-attachment: fixed, fixed, fixed, fixed;
  background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
  background-position: center, center, center, center;
  background-size: cover, cover, cover, cover;

  color-scheme: dark;
}

@media (prefers-reduced-motion: reduce){
  *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
}
@media (max-width: 820px){
  .glass{ backdrop-filter:none !important; }
}

:focus-visible{
  outline:2px solid rgba(59,130,246,.75);
  outline-offset:2px;
  border-radius:10px;
}

.container{ max-width:1120px; margin:auto; }

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}

.brand{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.brand h1{
  margin:0;
  font-size:15px;
  font-weight:800;
  letter-spacing:.2px;
}
.brand p{
  margin:0;
  font-size:12px;
  color:var(--muted);
}

.badges{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--border2);
  color:var(--muted);
  font-size:12px;
}
.dot{
  width:8px; height:8px; border-radius:99px;
  background:var(--accent);
  box-shadow:0 0 0 3px rgba(59,130,246,.14);
}

.card{
  background:linear-gradient(180deg, rgba(19, 29, 50, 0.833), rgba(15, 24, 42, 0.756));
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow);
  margin-bottom:14px;
}

.card h2, .card h3, .card h4{
  margin:0 0 12px 0;
  letter-spacing:.15px;
}
.card h2{ font-size:14px; font-weight:800; }
.card h3{ font-size:14px; font-weight:800; }
.card h4{ font-size:13px; font-weight:800; color:var(--muted); }

.glass{ backdrop-filter: blur(10px); }

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
  gap:14px;
}

.fullwidth{ grid-column: 1 / -1; }

.form{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:end;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:200px;
  flex:1;
}

label{
  font-size:11px;
  color:var(--muted2);
}

input, button{
  padding:11px 12px;
  border-radius:10px;
  border:1px solid transparent;
  font-size:14px;
  outline:none;
}

input{
  width:100%;
  color:var(--text);
  background:rgba(7,12,22,.60);
  border:1px solid rgba(255,255,255,.12);
  transition: border-color .14s ease, box-shadow .14s ease;
}
input::placeholder{ color:rgba(238,242,255,.35); }
input:focus{
  border-color:rgba(59,130,246,.65);
  box-shadow:0 0 0 4px rgba(59,130,246,.12);
}

button{
  cursor:pointer;
  border:1px solid rgba(59,130,246,.45);
  background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.92));
  color:#071224;
  font-weight:800;
  transition: transform .10s ease, box-shadow .10s ease, opacity .10s ease;
  will-change: transform;
}
button:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.18); }
button:active{ transform: translateY(0px); }
button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.btn-secondary{
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
}
.btn-secondary:hover{ box-shadow:0 10px 18px rgba(0,0,0,.16); }

.reset{
  background:rgba(239,68,68,.10);
  color:#ffd6d6;
  border:1px solid rgba(239,68,68,.35);
  margin-bottom:10px;
}
.reset:hover{ box-shadow:0 10px 18px rgba(239,68,68,.12); }

.smallnote{
  color:var(--muted2);
  font-size:12px;
  margin-top:10px;
  line-height:1.45;
}

/* SEM SCROLL HORIZONTAL */
.table-wrap{
  width:100%;
  overflow:hidden;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(7,12,22,.35);
}

/* TABELAS RESPONSIVAS */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

thead th{
  position:sticky;
  top:0;
  background:rgba(7,12,22,.90);
  border-bottom:1px solid rgba(255,255,255,.10);
  font-size:11px;
  color:rgba(238,242,255,.72);
  text-transform:uppercase;
  letter-spacing:.08em;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

td, th{
  padding:12px 10px;
  text-align:left;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

tbody tr{ border-bottom:1px solid rgba(255,255,255,.07); }
tbody tr:hover{ background:rgba(255,255,255,.03); }

.kpi{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  color:rgba(238,242,255,.76);
  font-size:12px;
}
.pill strong{ color:var(--text); font-weight:900; }
.pill .kpiDot{
  width:8px; height:8px; border-radius:999px;
  background:var(--accent);
}

/* ‚úÖ NOVO: c√©lula do n√∫mero com bot√£o √† direita */
.countcell{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:8px;
  overflow:visible !important; /* evita cortar o efeito */
}

.countnum{
  font-weight:900;
  min-width:22px;
  text-align:right;
}

/* ‚úÖ NOVO: bot√£o + chamativo (override do button padr√£o) */
.inc{
  width:24px;
  height:24px;
  padding:0;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  font-weight:900;
  line-height:1;
  background:rgba(42, 15, 15, 0);
  color:#eaf2ff;
  border:1px solid rgba(59, 131, 246, 0);

  box-shadow:
    0 10px 10px rgba(0,0,0,.18),
    0 0 0 0 rgba(59,130,246,.0);

  transition: transform .10s ease, box-shadow .12s ease, filter .12s ease;
}

.inc:hover{
  transform: translateY(-1px) scale(1.04);
  filter: brightness(1.06);
  box-shadow:
    0 12px 12px rgba(0,0,0,.22),
    0 0 0 6px rgba(59,130,246,.10);
}

.inc:active{
  transform: translateY(0px) scale(.98);
}

/* ‚úÖ EFEITO ao clicar (POP + GLOW) */
.inc.hit{
  animation: incPop .42s ease-out;
  box-shadow:
    0 10px 12px rgba(0,0,0,.28),
    0 0 0 10px rgba(59,130,246,.16),
    0 0 12px rgba(59,130,246,.25);
}

.countcell.hit{
  animation: cellFlash .55s ease-out;
}

.countcell.hit::after{
  content:"+1";
  position:absolute;
  right:44px;
  top:50%;
  transform: translateY(-50%);
  font-weight:900;
  font-size:12px;
  color:#cfe2ff;
  text-shadow: 0 10px 22px rgba(0,0,0,.35);
  animation: floatUp .65s ease-out forwards;
  pointer-events:none;
}

@keyframes incPop{
  0%   { transform: scale(.92); }
  35%  { transform: scale(1.16); }
  100% { transform: scale(1.00); }
}

@keyframes cellFlash{
  0%   { background: rgba(59,130,246,.00); }
  20%  { background: rgba(59,130,246,.12); }
  100% { background: rgba(59,130,246,.00); }
}

@keyframes floatUp{
  0%   { opacity:0; transform: translateY(-50%) translateX(0) scale(.92); }
  15%  { opacity:1; }
  100% { opacity:0; transform: translateY(-110%) translateX(-4px) scale(1.05); }
}

/* respeita prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  .inc.hit, .countcell.hit, .countcell.hit::after{ animation:none !important; }
}

.remove{
  background:rgba(239,68,68,.10);
  color:#ffd6d6;
  border:1px solid rgba(239,68,68,.35);
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
}
.remove:hover{ box-shadow:0 10px 18px rgba(239,68,68,.10); }

.rdlink{ color:#9ec5ff; text-decoration:none; font-weight:800; }
.rdlink:hover{ text-decoration:underline; }

.editable{
  cursor:text;
  border-radius:10px;
  padding:2px 6px;
}
.editable:focus{
  outline:none;
  background:rgba(59,130,246,.10);
  box-shadow:0 0 0 3px rgba(59,130,246,.10);
}

.top1 td{ color:#fbbf24; }
.top2 td{ color:#e5e7eb; }
.top3 td{ color:#fb923c; }

/* LOGIN */
#login{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.14), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
}

.login-card{ max-width:420px; width:100%; text-align:center; }
.login-card h2{ margin-bottom:6px; }
.login-card p{ margin:0 0 14px 0; color:var(--muted); font-size:12px; }
.login-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.10);
  margin:12px 0;
}

/* HIST√ìRICO */
.history-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  margin-top:4px;
}

.pager{ display:flex; gap:8px; align-items:center; }
.pager .mini{ padding:8px 10px; border-radius:10px; font-size:12px; font-weight:900; }
.pager .count{ color:rgba(238,242,255,.72); font-size:12px; padding:0 6px; }

.collapse-wrap{
  max-height:0;
  overflow:hidden;
  transition:max-height .20s ease;
}
.collapse-wrap.open{ max-height:820px; }

/* TOAST */
.toast{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:1000;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(7,12,22,.92);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(238,242,255,.92);
  font-size:12px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  display:none;
}
.toast .toast-wrap{
  display:flex;
  align-items:center;
  gap:10px;
}
.toast .toast-action{
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
  cursor:pointer;
}
.toast .toast-action:hover{ box-shadow:0 10px 18px rgba(0,0,0,.14); }

/* ‚úÖ NOVO: abas (Opera√ß√£o vs Dashboard) */
.tabs{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.tabbtn{
  padding:10px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  color:rgba(238,242,255,.84);
}
.tabbtn:hover{ box-shadow:0 10px 18px rgba(0,0,0,.14); }
.tabbtn.active{
  border-color:rgba(59,130,246,.45);
  background:linear-gradient(180deg, rgba(59,130,246,.22), rgba(37,99,235,.14));
  color:var(--text);
}
.view{ display:none; }
.view.active{ display:block; }

/* ‚úÖ Dashboard cards */
.dash-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
}
.dash-kpi{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.dash-kpi .label{
  color:var(--muted2);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.dash-kpi .value{
  font-size:20px;
  font-weight:900;
  letter-spacing:.2px;
}
.dash-kpi .sub{
  color:var(--muted);
  font-size:12px;
}

/* ‚úÖ NOVO: bot√µes pequenos */
.miniBtn{
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
  min-height:unset !important;
  line-height:1.1;
}

/* ‚úÖ NOVO: modo foco */
body.focusmode .focus-hide{ display:none !important; }
body.focusmode #cardDia{ grid-column: 1 / -1; }

/* ‚úÖ acessibilidade: aumenta alvo em mobile */
@media (max-width:560px){
  body{ padding:12px; }
  .card{ padding:14px; }
  td,th{ padding:10px 8px; font-size:12px; }
  button{ min-height:44px; }
  .tabbtn{ min-height:44px; }
}

/* ‚úÖ NOVO: TEMA CLARO */
body.light{
  --bg:#f6f7fb;
  --bg2:#eef2ff;
  --surface:#ffffff;
  --surface2:#f7f8ff;
  --border:rgba(15,23,42,.14);
  --border2:rgba(15,23,42,.10);
  --text:#0b1220;
  --muted:rgba(15,23,42,.72);
  --muted2:rgba(15,23,42,.55);
  --shadow:0 10px 26px rgba(0,0,0,.10);
  color-scheme: light;
}

body.light{
  background-color:#f6f7fb;
  background-image:
    radial-gradient(1200px 700px at 18% -10%, rgba(59,130,246,.14), transparent 60%),
    radial-gradient(900px 520px at 95% 10%, rgba(34,211,238,.08), transparent 55%),
    radial-gradient(1000px 600px at 50% 115%, rgba(99,102,241,.10), transparent 60%),
    linear-gradient(180deg, #f6f7fb 0%, #eef2ff 100%);
}

body.light .badge{
  background:rgba(15,23,42,.03);
  border:1px solid rgba(15,23,42,.10);
  color:var(--muted);
}

body.light .card{
  background:linear-gradient(180deg, rgba(255, 255, 255, 0.83), rgba(159, 168, 207, 0.173));
  border:1px solid rgba(15,23,42,.10);
  box-shadow:var(--shadow);
}

body.light input{
  background:rgba(255,255,255,.82);
  border:1px solid rgba(15,23,42,.14);
  color:var(--text);
}
body.light input::placeholder{ color:rgba(15,23,42,.40); }

body.light .table-wrap{
  background:rgba(255,255,255,.72);
  border:1px solid rgba(15,23,42,.12);
}

body.light thead th{
  background:rgba(255,255,255,.96);
  border-bottom:1px solid rgba(15,23,42,.10);
  color:rgba(15,23,42,.70);
}

body.light tbody tr{ border-bottom:1px solid rgba(15,23,42,.08); }
body.light tbody tr:hover{ background:rgba(15,23,42,.03); }

body.light .btn-secondary{
  background:rgba(15,23,42,.03);
  border:1px solid rgba(15,23,42,.12);
  color:var(--text);
}

body.light .toast{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(15,23,42,.12);
  color:rgba(15,23,42,.88);
}
body.light .toast .toast-action{
  background:rgba(15,23,42,.03);
  border:1px solid rgba(15,23,42,.12);
  color:var(--text);
}

body.light .rdlink{ color:#2563eb; }
body.light .inc{ color:#0b1220; }
body.light .dot{ box-shadow:0 0 0 3px rgba(59,130,246,.18); }

/* ‚úÖ PATCH: TEMA CLARO (MAIS CONTRASTE + ACESSIBILIDADE)
   Cole este bloco NO FIM do <style> para sobrescrever o tema claro atual.
*/
body.light{
  /* deixa os textos ‚Äúmuted‚Äù mais leg√≠veis no fundo claro */
  --muted: rgba(15,23,42,.82);
  --muted2: rgba(15,23,42,.72);

  /* bordas mais vis√≠veis no branco */
  --border: rgba(15,23,42,.18);
  --border2: rgba(15,23,42,.14);
}

/* Tipos pequenos (labels/notes) mais leg√≠veis */
body.light label{
  color: rgba(15,23,42,.80);
  font-weight: 700;
  font-size: 12px;
}
body.light .smallnote{
  color: rgba(15,23,42,.78);
}

/* Badges e pills (KPIs) ‚Äî no seu CSS base estavam ‚Äúclaros demais‚Äù pro tema branco */
body.light .badge{
  background: rgba(37, 99, 235, .10);
  border: 1px solid rgba(15,23,42,.14);
  color: rgba(15,23,42,.80);
}
body.light .pill{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.14);
  color: rgba(15,23,42,.82);
}
body.light .pill strong{
  color: var(--text);
}

/* Cards: melhora separa√ß√£o visual (pouco mais de contraste) */
body.light .card{
  border: 1px solid rgba(15,23,42,.14);
}
body.light .card h4{
  color: rgba(15,23,42,.78);
}

/* Inputs: foco mais evidente */
body.light input{
  background: rgba(255,255,255,.92);
  border: 1px solid rgba(15,23,42,.18);
}
body.light input:focus{
  border-color: rgba(6, 26, 67, 0.55);
  box-shadow: 0 0 0 4px rgba(37,99,235,.14);
}
body.light input::placeholder{
  color: rgba(15,23,42,.48);
}

/* Tabelas: cabe√ßalho e hover com contraste melhor */
body.light .table-wrap{
  background: rgba(255,255,255,.96);
  border: 1px solid rgba(15,23,42,.14);
}
body.light thead th{
  background: rgba(243,246,255,.98);
  border-bottom: 1px solid rgba(15,23,42,.14);
  color: rgba(15,23,42,.82);
}
body.light tbody tr{
  border-bottom: 1px solid rgba(15,23,42,.10);
}
body.light tbody tr:hover{
  background: rgba(37,99,235,.06);
}

/* Abas: mais ‚Äúclique‚Äù visual e leitura */
body.light .tabbtn{
  background: rgba(255,255,255,.86);
  border: 1px solid rgba(15,23,42,.16);
  color: rgba(15,23,42,.86);
}
body.light .tabbtn.active{
  background: rgba(37,99,235,.10);
  border-color: rgba(37,99,235,.36);
  color: rgba(15,23,42,.92);
}

/* Bot√µes de perigo (Reset / Remover) ‚Äî no branco o texto estava ‚Äúlavado‚Äù */
body.light .reset,
body.light .remove{
  background: rgba(239,68,68,.10);
  color: #7f1d1d;
  border: 1px solid rgba(239,68,68,.30);
}
body.light .reset:hover,
body.light .remove:hover{
  box-shadow: 0 10px 18px rgba(239,68,68,.12);
}

/* Bot√£o +1 (inc) ‚Äî antes ficava quase invis√≠vel no tema claro */
body.light .inc{
  background: rgba(37,99,235,.10);
  border: 1px solid rgba(37,99,235,.26);
  color: #1e3a8a;
  box-shadow: 0 8px 12px rgba(15,23,42,.10);
}
body.light .inc:hover{
  box-shadow:
    0 12px 16px rgba(15,23,42,.12),
    0 0 0 6px rgba(37,99,235,.10);
}
body.light .inc.hit{
  box-shadow:
    0 12px 16px rgba(15,23,42,.14),
    0 0 0 10px rgba(37,99,235,.16),
    0 0 12px rgba(37,99,235,.22);
}
/* ‚Äú+1‚Äù flutuante: no tema claro estava muito claro */
body.light .countcell.hit::after{
  color: #051133;
  text-shadow: none;
}

/* Top 3: cores mais escuras (melhor contraste no fundo branco) */
body.light tr.top1{ background: rgba(245,158,11,.10); }
body.light tr.top2{ background: rgba(148,163,184,.12); }
body.light tr.top3{ background: rgba(249,115,22,.10); }

body.light .top1 td{ color:#92400e; font-weight:900; }
body.light .top2 td{ color:#1f2937; font-weight:900; }
body.light .top3 td{ color:#9a3412; font-weight:900; }

/* Link RD: um pouco mais forte no claro */
body.light .rdlink{
  color: #d81d1d;
}

</style>
</head>

<body>

<div class="toast" id="toast"></div>

<div id="login">
  <div class="card glass login-card">
    <h2>Acesso ao CRM</h2>
    <p>Escolha seu perfil para entrar.</p>
    <div class="login-actions">
      <button onclick="entrarSDR()">Entrar como SDR</button>
      <button class="btn-secondary" onclick="entrarADM()">Entrar como ADM</button>
    </div>
  </div>
</div>

<div class="container">

  <div class="topbar">
    <div class="brand">
      <h1>CRM Leads</h1>
      <p id="subtituloView" style="margin-top:2px;">Opera√ß√£o</p>
    </div>

    <div class="tabs" role="tablist" aria-label="Modos do CRM">
      <button class="tabbtn" id="tabOperacao" type="button" role="tab" aria-selected="true" aria-controls="viewOperacao">Opera√ß√£o</button>
      <button class="tabbtn" id="tabGestao" type="button" role="tab" aria-selected="false" aria-controls="viewGestao">Gest√£o</button>

      <div class="badges" style="margin-left:6px;">
        <div class="badge" id="badgePerfil"><span class="dot"></span>Perfil: ‚Äî</div>
        <div class="badge" id="badgeStatus"><span class="dot"></span>Status: pronto</div>
        <div class="badge" id="badgeAtualizado"><span class="dot"></span>Atualizado: ‚Äî</div>
        <button class="btn-secondary miniBtn" id="btnTheme" type="button" title="Alternar tema" aria-label="Alternar tema">‚òÄÔ∏è Claro</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ VIEW: OPERA√á√ÉO (tudo que j√° existia fica aqui) -->
  <div class="view active" id="viewOperacao" role="tabpanel" aria-labelledby="tabOperacao">

    <div class="card glass">
      <h2>Adicionar Lead</h2>
      <div class="form">
        <div class="field" style="min-width:260px; flex:2;">
          <label for="nome">Nome do SDR</label>
          <input id="nome" placeholder="Ex: Jo√£o Silva" autocomplete="off" inputmode="text">
        </div>
        <div class="field" style="min-width:180px; flex:1;">
          <label for="qtd">Quantidade</label>
          <input id="qtd" type="number" placeholder="Ex: 3" inputmode="numeric">
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
            <button type="button" class="btn-secondary miniBtn quickAdd" data-q="1">+1</button>
            <button type="button" class="btn-secondary miniBtn quickAdd" data-q="3">+3</button>
            <button type="button" class="btn-secondary miniBtn quickAdd" data-q="5">+5</button>
            <button type="button" class="btn-secondary miniBtn quickAdd" data-q="10">+10</button>
            <button type="button" class="btn-secondary miniBtn quickAdd" data-q="15">+15</button>
          </div>
        </div>
        <div class="field" style="min-width:170px; flex:0;">
          <label>&nbsp;</label>
          <button id="btnAdd" style="width:170px;">Adicionar</button>
        </div>
      </div>
    </div>

    <!-- ‚úÖ NOVO: Busca/Filtro/Modo foco/Export -->
    <div class="card glass">
      <h2>A√ß√µes r√°pidas</h2>
      <div class="form">
        <div class="field" style="min-width:260px; flex:2;">
          <label for="searchSdr">Buscar SDR‚Ä¶</label>
          <input id="searchSdr" placeholder="Digite para filtrar o ranking" autocomplete="off" inputmode="search">
        </div>
        <div class="field" style="min-width:170px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnTopToggle" type="button" style="width:170px;">Mostrar Top 10</button>
        </div>
        <div class="field" style="min-width:170px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnFocusMode" type="button" style="width:170px;">Modo foco</button>
        </div>
        <div class="field admin-only" style="min-width:170px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnExportOperacao" type="button" style="width:170px;">Baixar CSV</button>
        </div>
      </div>
      <div class="smallnote">Atalhos: <strong>/</strong> foca busca ‚Ä¢ <strong>Esc</strong> limpa ‚Ä¢ <strong>Alt+F</strong> alterna foco</div>
    </div>

    <div class="grid">

      <div class="card glass" id="cardDia">
        <h3>üèÜ Ranking Di√°rio</h3>
        <button class="reset admin-only" onclick="resetar('dia')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingDia"></tbody></table>
        </div>
      </div>

      <div class="card glass focus-hide">
        <h3>üî• Ranking Semanal</h3>
        <button class="reset admin-only" onclick="resetar('semana')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingSemana"></tbody></table>
        </div>
      </div>

      <div class="card glass focus-hide">
        <h3>üìÖ Ranking Mensal</h3>
        <button class="reset admin-only" onclick="resetar('mes')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingMes"></tbody></table>
        </div>
      </div>

      <div class="card glass fullwidth focus-hide">
        <h3>üí∞ Ranking (Leads Virados / Faturamento do M√™s)</h3>

        <div class="kpi">
          <div class="pill" id="totalMesBox"><span class="kpiDot"></span>Total faturado: <strong>‚Äî</strong></div>
          <div class="pill" id="kpiClientes"><span class="kpiDot"></span>Clientes: <strong>‚Äî</strong></div>
        </div>

        <div class="form" style="margin-top:6px;">
          <div class="field" style="min-width:220px; flex:1;">
            <label for="sdrVirado">Nome do SDR</label>
            <input id="sdrVirado" placeholder="Ex: Maria" autocomplete="off">
          </div>

          <div class="field" style="min-width:260px; flex:2;">
            <label for="linkRdVirado">Link do RD (agendou)</label>
            <input id="linkRdVirado" placeholder="https://..." autocomplete="off">
          </div>

          <div class="field" style="min-width:180px; flex:1;">
            <label for="dataVirou">Data que virou cliente</label>
            <input id="dataVirou" type="date">
          </div>

          <div class="field" style="min-width:180px; flex:1;">
            <label for="valorVirado">Valor (R$)</label>
            <input id="valorVirado" type="number" step="0.01" placeholder="Ex: 2500" inputmode="decimal">
          </div>

          <div class="field" style="min-width:170px; flex:0;">
            <label>&nbsp;</label>
            <button id="btnAddVirado" style="width:170px;">Adicionar</button>
          </div>
        </div>

        <div class="smallnote">
          * Total e ranking do m√™s calculado
        </div>

        <hr class="sep">

        <h4>üìà Ranking autom√°tico por SDR (m√™s)</h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:70px">#</th>
                <th>SDR</th>
                <th style="width:90px">Clientes</th>
                <th style="width:140px">Faturamento</th>
              </tr>
            </thead>
            <tbody id="rankingVirados"></tbody>
          </table>
        </div>

        <hr class="sep">

        <div class="history-head">
          <h4 style="margin:0;">üìÑ Leads virados do m√™s</h4>
          <div class="pager">
            <button class="btn-secondary mini" id="btnToggleHistorico">Ver hist√≥rico</button>
            <button class="btn-secondary mini" id="btnPrev">‚óÄ</button>
            <div class="count" id="pageInfo">P√°gina 1</div>
            <button class="btn-secondary mini" id="btnNext">‚ñ∂</button>
          </div>
        </div>

        <div class="collapse-wrap" id="historicoWrap">
          <div class="table-wrap" style="margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width:140px">SDR</th>
                  <th style="width:70px">RD</th>
                  <th style="width:110px">Agendou</th>
                  <th style="width:110px">Virou</th>
                  <th style="width:120px">Valor</th>
                  <th style="width:60px"></th>
                </tr>
              </thead>
              <tbody id="listaViradosMes"></tbody>
            </table>
          </div>
        </div>

        <div class="smallnote" id="hintHistorico">Mostrando 5 registros por p√°gina.</div>
      </div>

    </div>
  </div>

  <!-- ‚úÖ VIEW: GEST√ÉO (dashboard simples, sem mudar suas tabelas) -->
  <div class="view" id="viewGestao" role="tabpanel" aria-labelledby="tabGestao">
    <div class="card glass">
      <h2>Dashboard (Gest√£o)</h2>

      <div class="dash-grid" style="margin-top:12px;">
        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Faturamento no m√™s</div>
            <div class="value" id="dashFaturamento">‚Äî</div>
            <div class="sub" id="dashFaturamentoSub">Atualiza conforme virados do m√™s</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Clientes no m√™s</div>
            <div class="value" id="dashClientes">‚Äî</div>
            <div class="sub">Total de virados no m√™s</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Top SDR (m√™s)</div>
            <div class="value" id="dashTopSdr">‚Äî</div>
            <div class="sub" id="dashTopSdrSub">Por faturamento no m√™s</div>
          </div>
        </div>
      </div>

      <hr class="sep">

      <!-- ‚úÖ NOVO: Comparativos autom√°ticos -->
      <h4>üìä Comparativos autom√°ticos</h4>
      <div class="dash-grid" style="margin-top:10px;">
        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Leads hoje vs ontem</div>
            <div class="value" id="cmpLeadsHoje">‚Äî</div>
            <div class="sub" id="cmpLeadsHojeSub">‚Äî</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Leads semana vs passada</div>
            <div class="value" id="cmpLeadsSemana">‚Äî</div>
            <div class="sub" id="cmpLeadsSemanaSub">‚Äî</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Leads m√™s Atual vs passado</div>
            <div class="value" id="cmpLeadsMes">‚Äî</div>
            <div class="sub" id="cmpLeadsMesSub">‚Äî</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Faturamento m√™s atual vs passado</div>
            <div class="value" id="cmpFatMes">‚Äî</div>
            <div class="sub" id="cmpFatMesSub">‚Äî</div>
          </div>
        </div>
      </div>

      <hr class="sep">

      <h4>üìå Ranking (m√™s) ‚Äì vis√£o Gest√£o</h4>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th>SDR</th>
              <th style="width:90px">Clientes</th>
              <th style="width:140px">Faturamento</th>
            </tr>
          </thead>
          <tbody id="dashRankingVirados"></tbody>
        </table>
      </div>

      <!-- ‚úÖ NOVO: Exporta√ß√µes -->
      <div class="form" style="margin-top:12px;">
        <div class="field" style="min-width:220px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnCsvRanking" type="button" style="width:220px;">Exportar ranking (CSV)</button>
        </div>
        <div class="field" style="min-width:220px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnCsvVirados" type="button" style="width:220px;">Exportar virados (CSV)</button>
        </div>

        <div class="field" style="min-width:240px; flex:0;">
          <label>&nbsp;</label>
          <button class="btn-secondary" id="btnRelatorioMes" type="button" style="width:240px;">Baixar relat√≥rio do m√™s</button>
        </div>
      </div>

      <hr class="sep">

    </div>
  </div>

</div>

<script>
const SENHA_ADM = "123456";
let perfil = null;

const supabaseClient = supabase.createClient(
  "https://ugyybmztaoopyetyrsit.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVneXlibXp0YW9vcHlldHlyc2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTczNDQsImV4cCI6MjA4Mzg5MzM0NH0.dLtrsK7XQNwM1DGMo-vv8llqZT5ajLKByfZIKLMOwgg"
);

const $ = (id) => document.getElementById(id);
const badgeStatus = $("badgeStatus");
const badgeAtualizado = $("badgeAtualizado");
const toastEl = $("toast");

/* ‚úÖ NOVO: tema (claro/escuro) */
function setTheme(mode){
  const m = (mode === "light") ? "light" : "dark";
  document.body.classList.toggle("light", m === "light");
  localStorage.setItem("crm_theme", m);
  const b = $("btnTheme");
  if (b) b.textContent = (m === "light") ? "üåô Escuro" : "‚òÄÔ∏è Claro";
}
function toggleTheme(){
  const isLight = document.body.classList.contains("light");
  setTheme(isLight ? "dark" : "light");
}
function initTheme(){
  const saved = localStorage.getItem("crm_theme");
  if (saved){
    setTheme(saved);
  } else {
    const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
    setTheme(prefersLight ? "light" : "dark");
  }
  const b = $("btnTheme");
  if (b) b.addEventListener("click", toggleTheme);
}
initTheme();

/* ‚úÖ NOVO: cache */
window.__rankingCache = [];
window.__viradosResumoCache = window.__viradosResumoCache || [];

let lastUpdatedAt = 0;

function fmtAgo(ms){
  const s = Math.floor(ms / 1000);
  if (s < 2) return "agora";
  if (s < 60) return `h√° ${s}s`;
  const m = Math.floor(s / 60);
  if (m < 60) return `h√° ${m}min`;
  const h = Math.floor(m / 60);
  return `h√° ${h}h`;
}

function renderUpdatedBadge(){
  if (!badgeAtualizado) return;
  if (!lastUpdatedAt){
    badgeAtualizado.innerHTML = `<span class="dot"></span>Atualizado: ‚Äî`;
    return;
  }
  badgeAtualizado.innerHTML = `<span class="dot"></span>Atualizado: ${fmtAgo(Date.now() - lastUpdatedAt)}`;
}

function markUpdated(){
  lastUpdatedAt = Date.now();
  renderUpdatedBadge();
}

/* atualiza o ‚Äúh√° Xs‚Äù sem recarregar dados */
setInterval(renderUpdatedBadge, 1000);

let inFlight = 0;
function setStatus(txt){
  badgeStatus.innerHTML = `<span class="dot"></span>Status: ${txt}`;
}

/* ‚úÖ NOVO: toast com a√ß√£o (Desfazer) */
let __toastAction = null;
let __toastTimer = null;

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function toast(msg, opts){
  opts = opts || {};
  const duration = Number(opts.duration || 2200);

  if (opts.action && opts.actionLabel){
    __toastAction = opts.action;
    toastEl.innerHTML = `<div class="toast-wrap"><span>${escapeHtml(msg)}</span><button type="button" class="toast-action" id="toastActionBtn">${escapeHtml(opts.actionLabel)}</button></div>`;
    const btn = toastEl.querySelector("#toastActionBtn");
    if (btn){
      btn.onclick = async () => {
        const fn = __toastAction;
        __toastAction = null;
        toastEl.style.display = "none";
        try{ if (fn) await fn(); }catch(e){}
      };
    }
  } else {
    __toastAction = null;
    toastEl.textContent = msg;
  }

  toastEl.style.display = "block";
  clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{
    toastEl.style.display="none";
    __toastAction = null;
  }, duration);
}

/* ‚úÖ CORRE√á√ÉO: supabase retorna "thenable" (query builder) que n√£o tem .finally()
      ent√£o o withLoading n√£o pode usar promise.finally.
      Aqui usamos try/finally com await (funciona com Promise e com thenable). */
async function withLoading(promiseLike){
  inFlight++;
  setStatus("carregando...");
  try{
    return await promiseLike;
  } finally {
    inFlight--;
    if(inFlight<=0) setStatus("pronto");
  }
}

function debounce(fn, ms){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ‚úÖ NOVO: ‚Äúusu√°rio‚Äù local (sem autentica√ß√£o) */
function getUserLabel(){
  const k = "crm_user_label";
  let v = localStorage.getItem(k);
  if (!v){
    v = "sessao-" + Math.random().toString(36).slice(2, 8);
    localStorage.setItem(k, v);
  }
  return v;
}

/* ‚úÖ NOVO: Audit log */
async function logEvent(ev){
  try{
    const payload = Object.assign({
      actor_perfil: perfil,
      actor_usuario: getUserLabel(),
      created_client_at: new Date().toISOString(),
      view: activeView
    }, ev || {});
    const { error } = await supabaseClient.from("ranking_events").insert(payload);
    if (error) {}
  }catch(err){}
}

function fmtDateTimeBR(dt){
  try{
    const d = new Date(dt);
    if (isNaN(d.getTime())) return String(dt || "");
    return d.toLocaleString("pt-BR");
  }catch(e){
    return String(dt || "");
  }
}

/* ‚úÖ ABAS: Opera√ß√£o x Gest√£o */
let activeView = "operacao";
function setActiveView(view){
  activeView = view;

  const isOperacao = view === "operacao";
  $("viewOperacao").classList.toggle("active", isOperacao);
  $("viewGestao").classList.toggle("active", !isOperacao);

  $("tabOperacao").classList.toggle("active", isOperacao);
  $("tabGestao").classList.toggle("active", !isOperacao);

  $("tabOperacao").setAttribute("aria-selected", String(isOperacao));
  $("tabGestao").setAttribute("aria-selected", String(!isOperacao));

  $("subtituloView").textContent = isOperacao ? "Opera√ß√£o" : "Gest√£o";

  /* quando entra na gest√£o, atualiza dashboard */
  if (!isOperacao) {
    withLoading(atualizarDashboardGestao());
  }
}

/* acessibilidade: atalhos de teclado nas abas */
function initTabs(){
  const op = $("tabOperacao");
  const ge = $("tabGestao");

  op.addEventListener("click", ()=>setActiveView("operacao"));
  ge.addEventListener("click", ()=>setActiveView("gestao"));

  [op, ge].forEach(btn=>{
    btn.addEventListener("keydown", (e)=>{
      if(e.key==="ArrowLeft" || e.key==="ArrowRight"){
        e.preventDefault();
        if(document.activeElement === op) ge.focus(); else op.focus();
      }
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        btn.click();
      }
    });
  });

  /* estado inicial */
  op.classList.add("active");
  ge.classList.remove("active");
}
initTabs();

/* ‚úÖ NOVO: busca + top10 */
let rankingFilter = "";
let showTop10 = false;

function applyFilterAndTop(arr){
  let out = Array.isArray(arr) ? arr : [];
  if (rankingFilter){
    const q = rankingFilter.toLowerCase();
    out = out.filter(p => String(p.nome || "").toLowerCase().includes(q));
  }
  if (showTop10) out = out.slice(0, 10);
  return out;
}

function initSearchAndTop(){
  const input = $("searchSdr");
  const btn = $("btnTopToggle");
  if (input){
    input.addEventListener("input", () => {
      rankingFilter = (input.value || "").trim();
      render("Dia", "leads_dia", window.__rankingCache);
      render("Semana", "leads_semana", window.__rankingCache);
      render("Mes", "leads_mes", window.__rankingCache);
    });
  }
  if (btn){
    btn.addEventListener("click", () => {
      showTop10 = !showTop10;
      btn.textContent = showTop10 ? "Mostrar todos" : "Mostrar Top 10";
      render("Dia", "leads_dia", window.__rankingCache);
      render("Semana", "leads_semana", window.__rankingCache);
      render("Mes", "leads_mes", window.__rankingCache);
    });
  }
}
initSearchAndTop();

/* ‚úÖ NOVO: modo foco */
function setFocusMode(on){
  document.body.classList.toggle("focusmode", !!on);
  localStorage.setItem("crm_focusmode", on ? "1" : "0");
  const b = $("btnFocusMode");
  if (b) b.textContent = on ? "Sair do foco" : "Modo foco";
}

function initFocusMode(){
  const saved = localStorage.getItem("crm_focusmode") === "1";
  setFocusMode(saved);
  const b = $("btnFocusMode");
  if (b){
    b.addEventListener("click", () => {
      const next = !document.body.classList.contains("focusmode");
      setFocusMode(next);
    });
  }
}
initFocusMode();

/* ‚úÖ NOVO: atalhos teclado (/ foca busca, Esc limpa, Alt+F foco) */
document.addEventListener("keydown", (e)=>{
  const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
  const isTyping = tag === "input" || tag === "textarea" || (e.target && e.target.isContentEditable);

  if (!isTyping && e.key === "/"){
    const s = $("searchSdr");
    if (s){
      e.preventDefault();
      s.focus();
    }
  }
  if (e.key === "Escape"){
    const s = $("searchSdr");
    if (s && document.activeElement === s){
      s.value = "";
      rankingFilter = "";
      render("Dia", "leads_dia", window.__rankingCache);
      render("Semana", "leads_semana", window.__rankingCache);
      render("Mes", "leads_mes", window.__rankingCache);
      s.blur();
    }
  }
  if (e.altKey && (e.key === "f" || e.key === "F")){
    e.preventDefault();
    setFocusMode(!document.body.classList.contains("focusmode"));
  }
});

/* Hist√≥rico */
const PAGE_SIZE = 5;
let historicoPage = 1;
let historicoTotal = 0;
let historicoOpen = false;

let cacheMonthKey = null;

/* LOGIN */
function entrarSDR() { perfil = "sdr"; iniciar(); }
function entrarADM() {
  const senha = prompt("Digite a senha de administrador:");
  if (senha === SENHA_ADM) { perfil = "admin"; iniciar(); }
  else alert("Senha incorreta");
}

function iniciar() {
  $("login").style.display = "none";
  $("badgePerfil").innerHTML = `<span class="dot"></span>Perfil: ${perfil === "admin" ? "ADM" : "SDR"}`;

  /* ‚úÖ regra: SDR n√£o acessa Gest√£o (voc√™ pode liberar depois se quiser) */
  if (perfil !== "admin") {
    document.querySelectorAll(".admin-only").forEach(b => b.remove());
    $("tabGestao").disabled = true;
    $("tabGestao").style.opacity = ".55";
    $("tabGestao").style.cursor = "not-allowed";
    setActiveView("operacao");
  } else {
    $("tabGestao").disabled = false;
  }

  carregar();
  startRealtime();
}

/* RANKINGS */
const nomeInput = $("nome");
const qtdInput = $("qtd");
$("btnAdd").onclick = () => withLoading(adicionar());

/* ‚úÖ NOVO: adicionar r√°pido (+1/+5/+10) */
document.querySelectorAll(".quickAdd").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const q = Number(btn.getAttribute("data-q") || "0");
    if (!q || q <= 0) return;
    qtdInput.value = String(q);
    await withLoading(adicionar("quick_btn", q));
  });
});

async function adicionar(originOverride, qtdOverride) {
  const nome = nomeInput.value.trim();
  const qtd = Number(qtdOverride || qtdInput.value);
  if (!nome || qtd <= 0) return alert("Preencha corretamente");

  const { data, error: selErr } = await supabaseClient
    .from("ranking")
    .select("id,nome,leads_dia,leads_semana,leads_mes")
    .eq("nome", nome)
    .maybeSingle();

  if (selErr) return alert("Erro ao buscar: " + (selErr.message || ""));

  if (data) {
    const { error } = await supabaseClient.from("ranking").update({
      leads_dia: (data.leads_dia || 0) + qtd,
      leads_semana: (data.leads_semana || 0) + qtd,
      leads_mes: (data.leads_mes || 0) + qtd
    }).eq("id", data.id);
    if (error) return alert("Erro ao atualizar: " + (error.message || ""));
  } else {
    const { error } = await supabaseClient.from("ranking").insert({
      nome, leads_dia: qtd, leads_semana: qtd, leads_mes: qtd
    });
    if (error) return alert("Erro ao inserir: " + (error.message || ""));
  }

  await logEvent({
    action: "ranking_add",
    sdr: nome,
    delta: qtd,
    period: "dia|semana|mes",
    origin: originOverride || "manual_form"
  });

  nomeInput.value = "";
  qtdInput.value = "";
  await carregarRanking();
  if (perfil === "admin") await atualizarDashboardGestao();
  toast("Lead adicionado");
}

function linha(p, i, campo) {
  const medalha = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
  const valor = (p[campo] || 0);

  return `
  <tr data-id="${p.id}" class="${i < 3 ? `top${i+1}` : ""}">
    <td style="width:70px">${medalha} ${i + 1}</td>

    <td contenteditable class="editable">${p.nome}</td>

    <td class="countcell" style="width:110px;">
      <span class="countnum">${valor}</span>
      <button class="inc" type="button" title="Adicionar +1 lead" aria-label="Adicionar 1 lead">Ôºã</button>
    </td>

    ${perfil === "admin" ? `<td style="width:60px"><button class="remove" type="button">X</button></td>` : ""}
  </tr>`;
}

async function carregarRanking() {
  const { data, error } = await supabaseClient
    .from("ranking")
    .select("id,nome,leads_dia,leads_semana,leads_mes");

  if (error || !data) {
    console.error(error);
    return;
  }

  const filtrado = (Array.isArray(data) ? data : []).filter(p => !String(p.nome || "").startsWith("__REMOVIDO__"));
  window.__rankingCache = filtrado;

  render("Dia", "leads_dia", filtrado);
  render("Semana", "leads_semana", filtrado);
  render("Mes", "leads_mes", filtrado);

  markUpdated();
}

function render(tipo, campo, data) {
  let rows = [...(Array.isArray(data) ? data : [])]
    .sort((a, b) => (b[campo] || 0) - (a[campo] || 0));

  rows = applyFilterAndTop(rows);

  $("ranking" + tipo).innerHTML =
    rows
      .map((p, i) => linha(p, i, campo))
      .join("");
}

/* ‚úÖ NOVO: desfazer do +1 */
let lastUndo = null;

async function doUndoRanking(undo){
  if (!undo) return;
  if (Date.now() > undo.expiresAt) return;

  const { id, delta } = undo;

  const { data, error: selErr } = await withLoading(
    supabaseClient
      .from("ranking")
      .select("id,nome,leads_dia,leads_semana,leads_mes")
      .eq("id", id)
      .maybeSingle()
  );

  if (selErr || !data) return;

  const nextDia = Math.max(0, (data.leads_dia || 0) - delta);
  const nextSem = Math.max(0, (data.leads_semana || 0) - delta);
  const nextMes = Math.max(0, (data.leads_mes || 0) - delta);

  const { error } = await withLoading(
    supabaseClient
      .from("ranking")
      .update({ leads_dia: nextDia, leads_semana: nextSem, leads_mes: nextMes })
      .eq("id", id)
  );

  if (error) return;

  await logEvent({
    action: "ranking_undo",
    sdr: data.nome || undo.sdrName || "",
    delta: -delta,
    period: "dia|semana|mes",
    origin: "toast_undo"
  });

  lastUndo = null;

  await withLoading(carregarRanking());
  if (perfil === "admin" && activeView === "gestao") await withLoading(atualizarDashboardGestao());
  toast("Desfeito");
}

async function resetar(tipo) {
  if (perfil !== "admin") return;

  const payload =
    tipo === "dia" ? { leads_dia: 0 } :
    tipo === "semana" ? { leads_semana: 0 } :
    tipo === "mes" ? { leads_mes: 0 } : null;

  if (!payload) return;

  const { error } = await withLoading(
    supabaseClient
      .from("ranking")
      .update(payload)
      .not("id", "is", null)
  );

  if (error) {
    alert("Erro ao resetar: " + (error.message || ""));
    return;
  }

  await logEvent({
    action: "ranking_reset",
    sdr: "",
    delta: 0,
    period: tipo,
    origin: "btn_reset"
  });

  await withLoading(carregarRanking());
  toast("Ranking resetado");
}

/* ‚úÖ EXCLUIR (ranking) com fallback + log */
document.addEventListener("click", async e => {
  if (!e.target || !e.target.classList) return;
  if (e.target.classList.contains("removeVirado")) return;

  if (e.target.classList.contains("inc")) {
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    if (!id) return;

    const cell = e.target.closest(".countcell");
    const btn = e.target;

    btn.classList.remove("hit");
    cell?.classList.remove("hit");
    void btn.offsetWidth;
    btn.classList.add("hit");
    cell?.classList.add("hit");
    setTimeout(()=>{
      btn.classList.remove("hit");
      cell?.classList.remove("hit");
    }, 650);

    const sdrName = (tr.querySelector(".editable")?.innerText || "").trim();

    const { data, error: selErr } = await withLoading(
      supabaseClient
        .from("ranking")
        .select("id,leads_dia,leads_semana,leads_mes")
        .eq("id", id)
        .maybeSingle()
    );

    if (selErr || !data) {
      alert("Erro ao buscar SDR: " + (selErr?.message || "Tente novamente"));
      return;
    }

    const delta = 1;

    const { error } = await withLoading(
      supabaseClient
        .from("ranking")
        .update({
          leads_dia: (data.leads_dia || 0) + delta,
          leads_semana: (data.leads_semana || 0) + delta,
          leads_mes: (data.leads_mes || 0) + delta
        })
        .eq("id", id)
    );

    if (error) {
      alert("Erro ao somar lead: " + (error.message || ""));
      return;
    }

    await logEvent({
      action: "ranking_inc",
      sdr: sdrName,
      delta: delta,
      period: "dia|semana|mes",
      origin: "btn_inc"
    });

    lastUndo = {
      id,
      delta,
      sdrName,
      expiresAt: Date.now() + 6500
    };

    await withLoading(carregarRanking());
    if (perfil === "admin" && activeView === "gestao") await withLoading(atualizarDashboardGestao());

    toast("+1 lead ‚Äî Desfazer", {
      actionLabel: "Desfazer",
      duration: 6500,
      action: async () => {
        const u = lastUndo;
        await doUndoRanking(u);
      }
    });

    return;
  }

  if (e.target.classList.contains("remove")) {
    if (perfil !== "admin") return;

    const tr = e.target.closest("tr");
    if (!tr) return;
    const id = tr.dataset.id;
    const sdrName = (tr.querySelector(".editable")?.innerText || "").trim();

    const { error } = await withLoading(supabaseClient.from("ranking").delete().eq("id", id));

    if (error) {
      const { error: uerr } = await withLoading(
        supabaseClient
          .from("ranking")
          .update({ nome: `__REMOVIDO__${id}`, leads_dia: 0, leads_semana: 0, leads_mes: 0 })
          .eq("id", id)
      );
      if (uerr) {
        alert("Erro ao excluir: " + (uerr.message || error.message || ""));
        return;
      }
    }

    await logEvent({
      action: "ranking_remove",
      sdr: sdrName,
      delta: 0,
      period: "dia|semana|mes",
      origin: "btn_remove"
    });

    await withLoading(carregarRanking());
    toast("Removido");
  }
});

const atualizarNomeDebounced = debounce(async (id, nome) => {
  const { error } = await withLoading(supabaseClient.from("ranking").update({ nome }).eq("id", id));
  if (error) {
    alert("Erro ao atualizar nome: " + (error.message || ""));
    return;
  }
  await logEvent({
    action: "ranking_rename",
    sdr: nome,
    delta: 0,
    period: "dia|semana|mes",
    origin: "inline_edit"
  });
  await withLoading(carregarRanking());
  toast("Nome atualizado");
}, 250);

document.addEventListener("blur", async e => {
  if (e.target.classList && e.target.classList.contains("editable")) {
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    const novo = (e.target.innerText || "").trim();
    if (!id || !novo) return;
    if (novo.startsWith("__REMOVIDO__")) return;
    atualizarNomeDebounced(id, novo);
  }
}, true);

/* LEADS VIRADOS */
const sdrViradoInput = $("sdrVirado");
const linkRdViradoInput = $("linkRdVirado");
const dataAgendouInput = $("dataAgendou");
const dataVirouInput = $("dataVirou");
const valorViradoInput = $("valorVirado");
const totalMesBox = $("totalMesBox");
const kpiClientes = $("kpiClientes");

$("btnAddVirado").onclick = () => withLoading(adicionarVirado());

$("btnToggleHistorico").onclick = () => {
  historicoOpen = !historicoOpen;
  $("historicoWrap").classList.toggle("open", historicoOpen);
  $("btnToggleHistorico").innerText = historicoOpen ? "Ocultar hist√≥rico" : "Ver hist√≥rico";
  if (historicoOpen) withLoading(carregarViradosPagina());
};

$("btnPrev").onclick = () => {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  historicoPage = Math.max(1, historicoPage - 1);
  if (historicoPage > totalPages) historicoPage = totalPages;
  withLoading(carregarViradosPagina());
};

$("btnNext").onclick = () => {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  historicoPage = Math.min(totalPages, historicoPage + 1);
  withLoading(carregarViradosPagina());
};

function normalizarLink(url) {
  const u = (url || "").trim();
  if (!u) return "";
  if (u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}
function fmtBRL(v) {
  const n = Number(v || 0);
  return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(n);
}
function mesAnoAtualLabel() {
  const d = new Date();
  return d.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
}
function getMesRangeISO() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
  return { startISO: start.toISOString().slice(0, 10), endISO: end.toISOString().slice(0, 10) };
}
function monthKey() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
}

async function adicionarVirado() {
  try{
    const sdr = (sdrViradoInput.value || "").trim();
    const link_rd = normalizarLink(linkRdViradoInput.value);

    const data_virou = (dataVirouInput.value || "").trim();

    const data_agendou = dataAgendouInput
      ? ((dataAgendouInput.value || "").trim() || data_virou)
      : data_virou;

    const valor = Number(valorViradoInput.value);

    if (!sdr) return alert("Preencha o Nome do SDR");
    if (!data_virou) return alert("Preencha a Data que virou cliente");
    if (!valor || valor <= 0) return alert("Preencha o Valor (R$) corretamente");

    const { error } = await supabaseClient
      .from("leads_virados")
      .insert({ sdr, link_rd, data_agendou, data_virou, valor });

    if (error) return alert("Erro ao adicionar: " + (error.message || "Tente novamente"));

    await logEvent({
      action: "virado_add",
      sdr,
      delta: 1,
      period: "mes",
      origin: "virado_form",
      valor: valor,
      data_virou: data_virou
    });

    sdrViradoInput.value = "";
    linkRdViradoInput.value = "";
    if (dataAgendouInput) dataAgendouInput.value = "";
    dataVirouInput.value = "";
    valorViradoInput.value = "";

    historicoPage = 1;
    cacheMonthKey = null;
    await carregarViradosResumo();
    if (historicoOpen) await carregarViradosPagina();

    if (perfil === "admin") await atualizarDashboardGestao();

    toast("Virado adicionado");
  }catch(err){
    alert("Erro no bot√£o Adicionar (virados): " + (err?.message || err));
  }
}

async function carregarViradosResumo() {
  const key = monthKey();
  if (cacheMonthKey === key && window.__viradosResumoCache) {
    aplicarResumo(window.__viradosResumoCache);
    return;
  }

  const { startISO, endISO } = getMesRangeISO();
  const { data, error } = await supabaseClient
    .from("leads_virados")
    .select("id,sdr,valor,data_virou")
    .gte("data_virou", startISO)
    .lt("data_virou", endISO);

  if (error) {
    totalMesBox.innerHTML = `<span class="kpiDot"></span>Total faturado: <strong style="color:#ffd6d6">Erro</strong>`;
    kpiClientes.innerHTML = `<span class="kpiDot"></span>Clientes: <strong style="color:#ffd6d6">Erro</strong>`;
    $("rankingVirados").innerHTML = "";
    historicoTotal = 0;
    atualizarPaginacao();
    return;
  }

  const viradosMes = Array.isArray(data) ? data : [];
  window.__viradosResumoCache = viradosMes;
  cacheMonthKey = key;
  aplicarResumo(viradosMes);

  historicoTotal = viradosMes.length;
  atualizarPaginacao();

  markUpdated();
}

function aplicarResumo(viradosMes) {
  let totalMes = 0;
  const map = {};
  for (const v of viradosMes) {
    const val = Number(v.valor || 0);
    totalMes += val;
    const sdr = (v.sdr || "").trim() || "Sem SDR";
    if (!map[sdr]) map[sdr] = { sdr, qtd: 0, total: 0 };
    map[sdr].qtd += 1;
    map[sdr].total += val;
  }

  const ranking = Object.values(map).sort((a, b) => (b.total || 0) - (a.total || 0));
  totalMesBox.innerHTML = `<span class="kpiDot"></span>Total faturado (${mesAnoAtualLabel()}): <strong>${fmtBRL(totalMes)}</strong>`;
  kpiClientes.innerHTML = `<span class="kpiDot"></span>Clientes: <strong>${viradosMes.length}</strong>`;

  $("rankingVirados").innerHTML =
    ranking.length
      ? ranking.map((it, i) => `
        <tr class="${i<3?`top${i+1}`:""}">
          <td style="width:70px">${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""} ${i+1}</td>
          <td>${it.sdr}</td>
          <td style="width:90px; font-weight:900;">${it.qtd}</td>
          <td style="width:140px; font-weight:900;">${fmtBRL(it.total)}</td>
        </tr>`).join("")
      : `<tr><td colspan="4" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros no m√™s.</td></tr>`;
}

async function carregarViradosPagina() {
  const { startISO, endISO } = getMesRangeISO();

  const from = (historicoPage - 1) * PAGE_SIZE;
  const to = from + PAGE_SIZE - 1;

  const { data, error, count } = await supabaseClient
    .from("leads_virados")
    .select("id,sdr,link_rd,data_agendou,data_virou,valor", { count: "exact" })
    .gte("data_virou", startISO)
    .lt("data_virou", endISO)
    .order("data_virou", { ascending: false })
    .range(from, to);

  if (typeof count === "number") historicoTotal = count;

  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  if (historicoPage > totalPages) historicoPage = totalPages;
  if (historicoPage < 1) historicoPage = 1;

  if (error) {
    $("listaViradosMes").innerHTML = `<tr><td colspan="6" style="padding:12px; color:rgba(238,242,255,.60);">Erro ao carregar hist√≥rico.</td></tr>`;
    atualizarPaginacao();
    return;
  }

  const pageItems = Array.isArray(data) ? data : [];
  $("listaViradosMes").innerHTML =
    pageItems.length
      ? pageItems.map(v => {
          const link = v.link_rd ? `<a class="rdlink" href="${v.link_rd}" target="_blank" rel="noopener noreferrer">Abrir</a>` : "";
          const btn = (perfil === "admin") ? `<button class="remove removeVirado" type="button">X</button>` : "";
          return `
            <tr data-id="${v.id}">
              <td>${v.sdr || ""}</td>
              <td>${link}</td>
              <td>${v.data_agendou ? String(v.data_agendou) : ""}</td>
              <td>${v.data_virou ? String(v.data_virou) : ""}</td>
              <td style="font-weight:900;">${fmtBRL(v.valor || 0)}</td>
              <td>${btn}</td>
            </tr>`;
        }).join("")
      : `<tr><td colspan="6" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros.</td></tr>`;

  atualizarPaginacao();
  markUpdated();
}

function atualizarPaginacao() {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  $("pageInfo").innerText = `P√°gina ${historicoPage} de ${totalPages}`;
  $("btnPrev").disabled = (historicoPage <= 1);
  $("btnNext").disabled = (historicoPage >= totalPages);
  $("hintHistorico").style.display = historicoTotal > 0 ? "block" : "none";
}

document.addEventListener("click", async e => {
  if (e.target.classList && e.target.classList.contains("removeVirado")) {
    if (perfil !== "admin") return;

    const id = e.target.closest("tr")?.dataset?.id;
    if (!id) return;

    const row = e.target.closest("tr");
    const sdrName = (row?.children?.[0]?.innerText || "").trim();

    const { error } = await withLoading(supabaseClient.from("leads_virados").delete().eq("id", id));

    if (error) {
      const { error: uerr } = await withLoading(
        supabaseClient
          .from("leads_virados")
          .update({
            sdr: `__REMOVIDO__${id}`,
            valor: 0,
            data_virou: "1900-01-01",
            data_agendou: "1900-01-01"
          })
          .eq("id", id)
      );
      if (uerr) {
        alert("Erro ao remover virado: " + (uerr.message || error.message || ""));
        return;
      }
    }

    await logEvent({
      action: "virado_remove",
      sdr: sdrName,
      delta: -1,
      period: "mes",
      origin: "btn_remove_virado"
    });

    cacheMonthKey = null;
    await withLoading(carregarViradosResumo());
    if (historicoOpen) await withLoading(carregarViradosPagina());

    if (perfil === "admin") await atualizarDashboardGestao();

    toast("Removido");
  }
});

/* ‚úÖ Dashboard Gest√£o: reaproveita o cache do resumo do m√™s */
async function atualizarDashboardGestao(){
  /* garante resumo carregado */
  if (!window.__viradosResumoCache || cacheMonthKey !== monthKey()){
    await carregarViradosResumo();
  }

  const viradosMes = Array.isArray(window.__viradosResumoCache) ? window.__viradosResumoCache : [];

  let totalMes = 0;
  const map = {};
  for (const v of viradosMes) {
    const val = Number(v.valor || 0);
    totalMes += val;
    const sdr = (v.sdr || "").trim() || "Sem SDR";
    if (!map[sdr]) map[sdr] = { sdr, qtd: 0, total: 0 };
    map[sdr].qtd += 1;
    map[sdr].total += val;
  }
  const ranking = Object.values(map).sort((a,b)=> (b.total||0)-(a.total||0));

  $("dashFaturamento").textContent = fmtBRL(totalMes);
  $("dashClientes").textContent = String(viradosMes.length);

  const top = ranking[0];
  $("dashTopSdr").textContent = top ? top.sdr : "‚Äî";
  $("dashTopSdrSub").textContent = top ? `${fmtBRL(top.total)} ‚Ä¢ ${top.qtd} cliente(s)` : "Por faturamento no m√™s";

  $("dashRankingVirados").innerHTML =
    ranking.length
      ? ranking.map((it, i) => `
        <tr class="${i<3?`top${i+1}`:""}">
          <td style="width:70px">${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""} ${i+1}</td>
          <td>${it.sdr}</td>
          <td style="width:90px; font-weight:900;">${it.qtd}</td>
          <td style="width:140px; font-weight:900;">${fmtBRL(it.total)}</td>
        </tr>`).join("")
      : `<tr><td colspan="4" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros no m√™s.</td></tr>`;

  await atualizarComparativosGestao();
  await carregarAuditLog();
}

/* ‚úÖ NOVO: Comparativos (Hoje vs Ontem / Semana vs passada / M√™s vs passado) */
function startOfDay(d){
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}
function startOfWeek(d){
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = x.getDay(); // 0 domingo
  const diff = (day === 0 ? -6 : 1 - day); // segunda como in√≠cio
  x.setDate(x.getDate() + diff);
  x.setHours(0,0,0,0);
  return x;
}
function startOfMonth(d){
  return new Date(d.getFullYear(), d.getMonth(), 1);
}
function addDays(d, n){
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
}
function addMonths(d, n){
  return new Date(d.getFullYear(), d.getMonth() + n, 1);
}
function isoDate(d){
  return d.toISOString().slice(0,10);
}
function fmtDelta(cur, prev){
  const c = Number(cur || 0);
  const p = Number(prev || 0);
  const diff = c - p;
  const sign = diff > 0 ? "+" : "";
  const pct = (p === 0) ? (c === 0 ? 0 : 100) : Math.round((diff / p) * 100);
  const pctSign = pct > 0 ? "+" : "";
  return { diff, sign, pct, pctSign };
}

async function sumLeadsEvents(startISO, endISO){
  try{
    const { data, error } = await supabaseClient
      .from("ranking_events")
      .select("*")
      .gte("created_at", startISO)
      .lt("created_at", endISO);

    if (error || !Array.isArray(data)) return null;

    let sum = 0;
    for (const ev of data){
      const a = String(ev.action || "");
      if (a.startsWith("ranking_")){
        const d = Number(ev.delta || 0);
        if (!isNaN(d)) sum += d;
      }
    }
    return sum;
  }catch(e){
    return null;
  }
}

async function sumViradosRange(startISO, endISO){
  try{
    const { data, error } = await supabaseClient
      .from("leads_virados")
      .select("valor")
      .gte("data_virou", startISO)
      .lt("data_virou", endISO);

    if (error || !Array.isArray(data)) return null;

    let sum = 0;
    for (const r of data){
      sum += Number(r.valor || 0);
    }
    return sum;
  }catch(e){
    return null;
  }
}

async function atualizarComparativosGestao(){
  const now = new Date();

  /* Leads: via ranking_events (created_at) */
  const todayStart = startOfDay(now);
  const tomorrowStart = addDays(todayStart, 1);
  const yestStart = addDays(todayStart, -1);

  const weekStart = startOfWeek(now);
  const nextWeekStart = addDays(weekStart, 7);
  const prevWeekStart = addDays(weekStart, -7);

  const monthStart = startOfMonth(now);
  const nextMonthStart = addMonths(monthStart, 1);
  const prevMonthStart = addMonths(monthStart, -1);

  const [leadsHoje, leadsOntem, leadsSemana, leadsSemanaPass, leadsMes, leadsMesPass] = await Promise.all([
    sumLeadsEvents(todayStart.toISOString(), tomorrowStart.toISOString()),
    sumLeadsEvents(yestStart.toISOString(), todayStart.toISOString()),
    sumLeadsEvents(weekStart.toISOString(), nextWeekStart.toISOString()),
    sumLeadsEvents(prevWeekStart.toISOString(), weekStart.toISOString()),
    sumLeadsEvents(monthStart.toISOString(), nextMonthStart.toISOString()),
    sumLeadsEvents(prevMonthStart.toISOString(), monthStart.toISOString())
  ]);

  const setCmp = (valueId, subId, cur, prev, labelPrev)=>{
    const el = $(valueId);
    const sub = $(subId);
    if (!el || !sub) return;

    if (cur === null || prev === null){
      el.textContent = "‚Äî";
      sub.textContent = "Sem dados";
      return;
    }
    const d = fmtDelta(cur, prev);
    el.textContent = String(cur);
    sub.textContent = `${labelPrev}: ${prev} ‚Ä¢ Œî ${d.sign}${d.diff} (${d.pctSign}${d.pct}%)`;
  };

  setCmp("cmpLeadsHoje", "cmpLeadsHojeSub", leadsHoje, leadsOntem, "Ontem");
  setCmp("cmpLeadsSemana", "cmpLeadsSemanaSub", leadsSemana, leadsSemanaPass, "Semana passada");
  setCmp("cmpLeadsMes", "cmpLeadsMesSub", leadsMes, leadsMesPass, "M√™s passado");

  /* Faturamento: via leads_virados (data_virou) */
  const todayISO = isoDate(todayStart);
  const tomorrowISO = isoDate(tomorrowStart);
  const yestISO = isoDate(yestStart);

  const weekISO = isoDate(weekStart);
  const nextWeekISO = isoDate(nextWeekStart);
  const prevWeekISO = isoDate(prevWeekStart);

  const monthISO = isoDate(monthStart);
  const nextMonthISO = isoDate(nextMonthStart);
  const prevMonthISO = isoDate(prevMonthStart);

  const [fatHoje, fatOntem, fatSemana, fatSemanaPass, fatMes, fatMesPass] = await Promise.all([
    sumViradosRange(todayISO, tomorrowISO),
    sumViradosRange(yestISO, todayISO),
    sumViradosRange(weekISO, nextWeekISO),
    sumViradosRange(prevWeekISO, weekISO),
    sumViradosRange(monthISO, nextMonthISO),
    sumViradosRange(prevMonthISO, monthISO),
  ]);

  const setCmpMoney = (valueId, subId, cur, prev, labelPrev)=>{
    const el = $(valueId);
    const sub = $(subId);
    if (!el || !sub) return;

    if (cur === null || prev === null){
      el.textContent = "‚Äî";
      sub.textContent = "Sem dados";
      return;
    }
    const d = fmtDelta(cur, prev);
    el.textContent = fmtBRL(cur);
    sub.textContent = `${labelPrev}: ${fmtBRL(prev)} ‚Ä¢ Œî ${d.sign}${fmtBRL(d.diff)} (${d.pctSign}${d.pct}%)`;
  };

  setCmpMoney("cmpFatHoje", "cmpFatHojeSub", fatHoje, fatOntem, "Ontem");
  setCmpMoney("cmpFatSemana", "cmpFatSemanaSub", fatSemana, fatSemanaPass, "Semana passada");
  setCmpMoney("cmpFatMes", "cmpFatMesSub", fatMes, fatMesPass, "M√™s passado");
}

/* ‚úÖ NOVO: Atividade recente */
async function carregarAuditLog(){
  const tbody = $("auditBody");
  if (!tbody) return;

  try{
    const { data, error } = await supabaseClient
      .from("ranking_events")
      .select("*")
      .order("created_at", { ascending:false })
      .limit(20);

    if (error || !Array.isArray(data)){
      tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(238,242,255,.60);">Sem dados.</td></tr>`;
      return;
    }

    tbody.innerHTML = data.length ? data.map(ev=>{
      const when = fmtDateTimeBR(ev.created_at || ev.created_client_at || "");
      const who = (ev.actor_usuario || ev.actor_perfil || "‚Äî");
      const act = (ev.action || "‚Äî");
      const sdr = (ev.sdr || "‚Äî");
      const delta = (typeof ev.delta === "number" || String(ev.delta||"").trim() !== "") ? String(ev.delta) : "‚Äî";
      const period = (ev.period || "‚Äî");
      const origin = (ev.origin || "‚Äî");
      return `<tr>
        <td style="width:150px">${escapeHtml(when)}</td>
        <td style="width:110px">${escapeHtml(who)}</td>
        <td style="width:140px">${escapeHtml(act)}</td>
        <td>${escapeHtml(sdr)}</td>
        <td style="width:90px; font-weight:900;">${escapeHtml(delta)}</td>
        <td style="width:120px">${escapeHtml(period)}</td>
        <td style="width:140px">${escapeHtml(origin)}</td>
      </tr>`;
    }).join("") : `<tr><td colspan="7" style="padding:12px; color:rgba(238,242,255,.60);">Sem eventos.</td></tr>`;
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:12px; color:rgba(238,242,255,.60);">Sem dados.</td></tr>`;
  }
}

/* ‚úÖ NOVO: Exportar CSV */
function downloadText(filename, text){
  const blob = new Blob([text], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function toCSV(rows){
  return rows.map(r => r.map(v => {
    const s = String(v ?? "");
    const needs = /[",\n;]/.test(s);
    const val = s.replaceAll('"','""');
    return needs ? `"${val}"` : val;
  }).join(";")).join("\n");
}

async function exportRankingCSV(){
  const data = Array.isArray(window.__rankingCache) ? window.__rankingCache : [];
  const rows = [["nome","leads_dia","leads_semana","leads_mes"]];
  for (const r of data){
    rows.push([r.nome || "", r.leads_dia || 0, r.leads_semana || 0, r.leads_mes || 0]);
  }
  downloadText(`ranking_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows));
}

async function exportViradosCSV(){
  const { startISO, endISO } = getMesRangeISO();
  const { data, error } = await supabaseClient
    .from("leads_virados")
    .select("sdr,link_rd,data_agendou,data_virou,valor")
    .gte("data_virou", startISO)
    .lt("data_virou", endISO)
    .order("data_virou", { ascending:false });

  const rows = [["sdr","link_rd","data_agendou","data_virou","valor"]];
  if (!error && Array.isArray(data)){
    for (const v of data){
      rows.push([v.sdr || "", v.link_rd || "", v.data_agendou || "", v.data_virou || "", v.valor || 0]);
    }
  }
  downloadText(`virados_${monthKey()}.csv`, toCSV(rows));
}

async function exportAuditCSV(){
  const { data, error } = await supabaseClient
    .from("ranking_events")
    .select("*")
    .order("created_at", { ascending:false })
    .limit(500);

  const rows = [["created_at","actor_perfil","actor_usuario","action","sdr","delta","period","origin"]];
  if (!error && Array.isArray(data)){
    for (const ev of data){
      rows.push([
        ev.created_at || ev.created_client_at || "",
        ev.actor_perfil || "",
        ev.actor_usuario || "",
        ev.action || "",
        ev.sdr || "",
        (typeof ev.delta === "number" ? ev.delta : (ev.delta ?? "")),
        ev.period || "",
        ev.origin || ""
      ]);
    }
  }
  downloadText(`atividades_${new Date().toISOString().slice(0,10)}.csv`, toCSV(rows));
}

async function exportRelatorioMes(){
  const key = monthKey();

  /* Ranking atual */
  const rankRows = [["SECAO: RANKING (ATUAL)"],["nome","leads_dia","leads_semana","leads_mes"]];
  const rdata = Array.isArray(window.__rankingCache) ? window.__rankingCache : [];
  for (const r of rdata){
    rankRows.push([r.nome || "", r.leads_dia || 0, r.leads_semana || 0, r.leads_mes || 0]);
  }

  /* Virados do m√™s */
  const { startISO, endISO } = getMesRangeISO();
  const { data: vdata } = await supabaseClient
    .from("leads_virados")
    .select("sdr,link_rd,data_agendou,data_virou,valor")
    .gte("data_virou", startISO)
    .lt("data_virou", endISO)
    .order("data_virou", { ascending:false });

  const virRows = [[""],["SECAO: VIRADOS (MES)"],["sdr","link_rd","data_agendou","data_virou","valor"]];
  if (Array.isArray(vdata)){
    for (const v of vdata){
      virRows.push([v.sdr || "", v.link_rd || "", v.data_agendou || "", v.data_virou || "", v.valor || 0]);
    }
  }

  /* Eventos do m√™s */
  const mStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
  const mEnd = new Date(new Date().getFullYear(), new Date().getMonth()+1, 1);
  const { data: edata } = await supabaseClient
    .from("ranking_events")
    .select("*")
    .gte("created_at", mStart.toISOString())
    .lt("created_at", mEnd.toISOString())
    .order("created_at", { ascending:false })
    .limit(2000);

  const evRows = [[""],["SECAO: ATIVIDADES (MES)"],["created_at","actor_perfil","actor_usuario","action","sdr","delta","period","origin"]];
  if (Array.isArray(edata)){
    for (const ev of edata){
      evRows.push([
        ev.created_at || ev.created_client_at || "",
        ev.actor_perfil || "",
        ev.actor_usuario || "",
        ev.action || "",
        ev.sdr || "",
        (typeof ev.delta === "number" ? ev.delta : (ev.delta ?? "")),
        ev.period || "",
        ev.origin || ""
      ]);
    }
  }

  const all = []
    .concat(rankRows)
    .concat(virRows)
    .concat(evRows);

  downloadText(`relatorio_${key}.csv`, toCSV(all));
}

/* bind export buttons */
(function initExports(){
  const b1 = $("btnCsvRanking");
  const b2 = $("btnCsvVirados");
  const b3 = $("btnCsvAudit");
  const b4 = $("btnRelatorioMes");
  const bOp = $("btnExportOperacao");

  if (b1) b1.onclick = () => withLoading(exportRankingCSV());
  if (b2) b2.onclick = () => withLoading(exportViradosCSV());
  if (b3) b3.onclick = () => withLoading(exportAuditCSV());
  if (b4) b4.onclick = () => withLoading(exportRelatorioMes());
  if (bOp) bOp.onclick = () => withLoading(exportRankingCSV());
})();

/* ‚úÖ REALTIME */
let rtChannel = null;

const refreshFromRealtime = debounce(async () => {
  if (!perfil) return;

  await withLoading((async () => {
    await carregarRanking();

    cacheMonthKey = null;
    await carregarViradosResumo();

    if (historicoOpen) await carregarViradosPagina();

    if (perfil === "admin" && activeView === "gestao") {
      await atualizarDashboardGestao();
    }

    markUpdated();
  })());
}, 350);

function startRealtime(){
  if (rtChannel) return;

  rtChannel = supabaseClient
    .channel("crm-realtime")
    .on("postgres_changes", { event: "*", schema: "public", table: "ranking" }, () => {
      refreshFromRealtime();
    })
    .on("postgres_changes", { event: "*", schema: "public", table: "leads_virados" }, () => {
      refreshFromRealtime();
    })
    .on("postgres_changes", { event: "*", schema: "public", table: "ranking_events" }, () => {
      if (perfil === "admin" && activeView === "gestao") refreshFromRealtime();
    });

  rtChannel.subscribe((status) => {
    // status: SUBSCRIBED / TIMED_OUT / CLOSED / CHANNEL_ERROR
  });

  window.addEventListener("beforeunload", stopRealtime);
}

function stopRealtime(){
  if (!rtChannel) return;
  supabaseClient.removeChannel(rtChannel);
  rtChannel = null;
}

/* BOOT */
async function carregar() {
  await withLoading(carregarRanking());
  await withLoading(carregarViradosResumo());
  if (perfil === "admin" && activeView === "gestao") await withLoading(atualizarDashboardGestao());
}

/* Enter */
nomeInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAdd").click(); });
qtdInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAdd").click(); });
sdrViradoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAddVirado").click(); });
valorViradoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAddVirado").click(); });


</script>


</body>
</html>
