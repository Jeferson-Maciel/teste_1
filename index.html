<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Leads</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================
   DESIGN MAIS FORMAL (SEM MUDAR FUNCIONALIDADES)
   ========================= */
:root{
  --bg:#0b1220;
  --bg2:#0a1222;
  --surface:#101a2e;
  --surface2:#0f182a;
  --border:rgba(255,255,255,.12);  /* acessibilidade: um pouco mais vis√≠vel */
  --border2:rgba(255,255,255,.10); /* acessibilidade: um pouco mais vis√≠vel */
  --text:#eef2ff;
  --muted:rgba(238,242,255,.78);   /* acessibilidade: melhora contraste */
  --muted2:rgba(238,242,255,.60);  /* acessibilidade: melhora contraste */

  --accent:#3b82f6;
  --accent2:#2563eb;
  --danger:#ef4444;

  --shadow:0 10px 26px rgba(0,0,0,.34);
  --radius:14px;
  --radius2:12px;
}

*{ box-sizing:border-box; font-family:'Inter',sans-serif; }
html,body{ height:100%; }

/* ‚úÖ acessibilidade: tipografia responsiva e foco vis√≠vel */
body{
  margin:0;
  padding:18px;
  color:var(--text);
  min-height:100vh;
  font-size:clamp(13px, 1.05vw, 14px);
  line-height:1.35;

  /* fundo base s√≥lido (n√£o ‚Äúacaba‚Äù ao rolar) */
  background-color: #0b1220;

  /* gradiente profissional + moderno (infinito) */
  background-image:
    radial-gradient(1200px 700px at 18% -10%, rgba(59,130,246,.18), transparent 60%),
    radial-gradient(900px 520px at 95% 10%, rgba(34,211,238,.10), transparent 55%),
    radial-gradient(1000px 600px at 50% 115%, rgba(99,102,241,.12), transparent 60%),
    linear-gradient(180deg, #0b1220 0%, #0a1222 100%);

  /* ‚Äúinfinito‚Äù: fixa no viewport, n√£o repete por altura da p√°gina */
  background-attachment: fixed, fixed, fixed, fixed;
  background-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
  background-position: center, center, center, center;
  background-size: cover, cover, cover, cover;
}

@media (prefers-reduced-motion: reduce){
  *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; }
}
@media (max-width: 820px){
  .glass{ backdrop-filter:none !important; }
}

:focus-visible{
  outline:2px solid rgba(59,130,246,.75);
  outline-offset:2px;
  border-radius:10px;
}

.container{ max-width:1120px; margin:auto; }

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}

.brand{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.brand h1{
  margin:0;
  font-size:15px;
  font-weight:800;
  letter-spacing:.2px;
}
.brand p{
  margin:0;
  font-size:12px;
  color:var(--muted);
}

.badges{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.04);
  border:1px solid var(--border2);
  color:var(--muted);
  font-size:12px;
}
.dot{
  width:8px; height:8px; border-radius:99px;
  background:var(--accent);
  box-shadow:0 0 0 3px rgba(59,130,246,.14);
}

.card{
  background:linear-gradient(180deg, rgba(19, 29, 50, 0.833), rgba(15, 24, 42, 0.756));
  border:1px solid var(--border2);
  border-radius:var(--radius);
  padding:18px;
  box-shadow:var(--shadow);
  margin-bottom:14px;
}

.card h2, .card h3, .card h4{
  margin:0 0 12px 0;
  letter-spacing:.15px;
}
.card h2{ font-size:14px; font-weight:800; }
.card h3{ font-size:14px; font-weight:800; }
.card h4{ font-size:13px; font-weight:800; color:var(--muted); }

.glass{ backdrop-filter: blur(10px); }

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
  gap:14px;
}

.fullwidth{ grid-column: 1 / -1; }

.form{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:end;
}

.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width:200px;
  flex:1;
}

label{
  font-size:11px;
  color:var(--muted2);
}

input, button{
  padding:11px 12px;
  border-radius:10px;
  border:1px solid transparent;
  font-size:14px;
  outline:none;
}

input{
  width:100%;
  color:var(--text);
  background:rgba(7,12,22,.60);
  border:1px solid rgba(255,255,255,.12);
  transition: border-color .14s ease, box-shadow .14s ease;
}
input::placeholder{ color:rgba(238,242,255,.35); }
input:focus{
  border-color:rgba(59,130,246,.65);
  box-shadow:0 0 0 4px rgba(59,130,246,.12);
}

button{
  cursor:pointer;
  border:1px solid rgba(59,130,246,.45);
  background:linear-gradient(180deg, rgba(59,130,246,.95), rgba(37,99,235,.92));
  color:#071224;
  font-weight:800;
  transition: transform .10s ease, box-shadow .10s ease, opacity .10s ease;
  will-change: transform;
}
button:hover{ transform: translateY(-1px); box-shadow:0 10px 18px rgba(0,0,0,.18); }
button:active{ transform: translateY(0px); }
button:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

.btn-secondary{
  background:rgba(255,255,255,.04);
  color:var(--text);
  border:1px solid rgba(255,255,255,.12);
}
.btn-secondary:hover{ box-shadow:0 10px 18px rgba(0,0,0,.16); }

.reset{
  background:rgba(239,68,68,.10);
  color:#ffd6d6;
  border:1px solid rgba(239,68,68,.35);
  margin-bottom:10px;
}
.reset:hover{ box-shadow:0 10px 18px rgba(239,68,68,.12); }

.smallnote{
  color:var(--muted2);
  font-size:12px;
  margin-top:10px;
  line-height:1.45;
}

/* SEM SCROLL HORIZONTAL */
.table-wrap{
  width:100%;
  overflow:hidden;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(7,12,22,.35);
}

/* TABELAS RESPONSIVAS */
table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

thead th{
  position:sticky;
  top:0;
  background:rgba(7,12,22,.90);
  border-bottom:1px solid rgba(255,255,255,.10);
  font-size:11px;
  color:rgba(238,242,255,.72);
  text-transform:uppercase;
  letter-spacing:.08em;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

td, th{
  padding:12px 10px;
  text-align:left;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

tbody tr{ border-bottom:1px solid rgba(255,255,255,.07); }
tbody tr:hover{ background:rgba(255,255,255,.03); }

.kpi{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  color:rgba(238,242,255,.76);
  font-size:12px;
}
.pill strong{ color:var(--text); font-weight:900; }
.pill .kpiDot{
  width:8px; height:8px; border-radius:999px;
  background:var(--accent);
}

.remove{
  background:rgba(239,68,68,.10);
  color:#ffd6d6;
  border:1px solid rgba(239,68,68,.35);
  padding:8px 10px;
  border-radius:10px;
  font-size:12px;
  font-weight:900;
}
.remove:hover{ box-shadow:0 10px 18px rgba(239,68,68,.10); }

.rdlink{ color:#9ec5ff; text-decoration:none; font-weight:800; }
.rdlink:hover{ text-decoration:underline; }

.editable{
  cursor:text;
  border-radius:10px;
  padding:2px 6px;
}
.editable:focus{
  outline:none;
  background:rgba(59,130,246,.10);
  box-shadow:0 0 0 3px rgba(59,130,246,.10);
}

.top1 td{ color:#fbbf24; }
.top2 td{ color:#e5e7eb; }
.top3 td{ color:#fb923c; }

/* LOGIN */
#login{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(59,130,246,.14), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
}

.login-card{ max-width:420px; width:100%; text-align:center; }
.login-card h2{ margin-bottom:6px; }
.login-card p{ margin:0 0 14px 0; color:var(--muted); font-size:12px; }
.login-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

.sep{
  border:none;
  border-top:1px solid rgba(255,255,255,.10);
  margin:12px 0;
}

/* HIST√ìRICO */
.history-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  margin-top:4px;
}

.pager{ display:flex; gap:8px; align-items:center; }
.pager .mini{ padding:8px 10px; border-radius:10px; font-size:12px; font-weight:900; }
.pager .count{ color:rgba(238,242,255,.72); font-size:12px; padding:0 6px; }

.collapse-wrap{
  max-height:0;
  overflow:hidden;
  transition:max-height .20s ease;
}
.collapse-wrap.open{ max-height:820px; }

.toast{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:1000;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(7,12,22,.92);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(238,242,255,.92);
  font-size:12px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
  display:none;
}

/* ‚úÖ NOVO: abas (Opera√ß√£o vs Dashboard) */
.tabs{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.tabbtn{
  padding:10px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  color:rgba(238,242,255,.84);
}
.tabbtn:hover{ box-shadow:0 10px 18px rgba(0,0,0,.14); }
.tabbtn.active{
  border-color:rgba(59,130,246,.45);
  background:linear-gradient(180deg, rgba(59,130,246,.22), rgba(37,99,235,.14));
  color:var(--text);
}
.view{ display:none; }
.view.active{ display:block; }

/* ‚úÖ Dashboard cards */
.dash-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
}
.dash-kpi{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.dash-kpi .label{
  color:var(--muted2);
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.dash-kpi .value{
  font-size:20px;
  font-weight:900;
  letter-spacing:.2px;
}
.dash-kpi .sub{
  color:var(--muted);
  font-size:12px;
}

/* ‚úÖ acessibilidade: aumenta alvo em mobile */
@media (max-width:560px){
  body{ padding:12px; }
  .card{ padding:14px; }
  td,th{ padding:10px 8px; font-size:12px; }
  button{ min-height:44px; }
  .tabbtn{ min-height:44px; }
}
</style>
</head>

<body>

<div class="toast" id="toast"></div>

<div id="login">
  <div class="card glass login-card">
    <h2>Acesso ao CRM</h2>
    <p>Escolha seu perfil para entrar.</p>
    <div class="login-actions">
      <button onclick="entrarSDR()">Entrar como SDR</button>
      <button class="btn-secondary" onclick="entrarADM()">Entrar como ADM</button>
    </div>
  </div>
</div>

<div class="container">

  <div class="topbar">
    <div class="brand">
      <h1>CRM Leads</h1>
      <p id="subtituloView" style="margin-top:2px;">Opera√ß√£o</p>
    </div>

    <div class="tabs" role="tablist" aria-label="Modos do CRM">
      <button class="tabbtn" id="tabOperacao" type="button" role="tab" aria-selected="true" aria-controls="viewOperacao">Opera√ß√£o</button>
      <button class="tabbtn" id="tabGestao" type="button" role="tab" aria-selected="false" aria-controls="viewGestao">Gest√£o</button>

      <div class="badges" style="margin-left:6px;">
        <div class="badge" id="badgePerfil"><span class="dot"></span>Perfil: ‚Äî</div>
        <div class="badge" id="badgeStatus"><span class="dot"></span>Status: pronto</div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ VIEW: OPERA√á√ÉO (tudo que j√° existia fica aqui) -->
  <div class="view active" id="viewOperacao" role="tabpanel" aria-labelledby="tabOperacao">

    <div class="card glass">
      <h2>Adicionar Lead</h2>
      <div class="form">
        <div class="field" style="min-width:260px; flex:2;">
          <label for="nome">Nome do SDR</label>
          <input id="nome" placeholder="Ex: Jo√£o Silva" autocomplete="off" inputmode="text">
        </div>
        <div class="field" style="min-width:180px; flex:1;">
          <label for="qtd">Quantidade</label>
          <input id="qtd" type="number" placeholder="Ex: 3" inputmode="numeric">
        </div>
        <div class="field" style="min-width:170px; flex:0;">
          <label>&nbsp;</label>
          <button id="btnAdd" style="width:170px;">Adicionar</button>
        </div>
      </div>
    </div>

    <div class="grid">

      <div class="card glass">
        <h3>üèÜ Ranking Di√°rio</h3>
        <button class="reset admin-only" onclick="resetar('dia')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingDia"></tbody></table>
        </div>
      </div>

      <div class="card glass">
        <h3>üî• Ranking Semanal</h3>
        <button class="reset admin-only" onclick="resetar('semana')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingSemana"></tbody></table>
        </div>
      </div>

      <div class="card glass">
        <h3>üìÖ Ranking Mensal</h3>
        <button class="reset admin-only" onclick="resetar('mes')">Resetar</button>
        <div class="table-wrap">
          <table><tbody id="rankingMes"></tbody></table>
        </div>
      </div>

      <div class="card glass fullwidth">
        <h3>üí∞ Ranking (Leads Virados / Faturamento do M√™s)</h3>

        <div class="kpi">
          <div class="pill" id="totalMesBox"><span class="kpiDot"></span>Total faturado: <strong>‚Äî</strong></div>
          <div class="pill" id="kpiClientes"><span class="kpiDot"></span>Clientes: <strong>‚Äî</strong></div>
        </div>

        <div class="form" style="margin-top:6px;">
          <div class="field" style="min-width:220px; flex:1;">
            <label for="sdrVirado">Nome do SDR</label>
            <input id="sdrVirado" placeholder="Ex: Maria" autocomplete="off">
          </div>

          <div class="field" style="min-width:260px; flex:2;">
            <label for="linkRdVirado">Link do RD (agendou)</label>
            <input id="linkRdVirado" placeholder="https://..." autocomplete="off">
          </div>

          <div class="field" style="min-width:180px; flex:1;">
            <label for="dataVirou">Data que virou cliente</label>
            <input id="dataVirou" type="date">
          </div>

          <div class="field" style="min-width:180px; flex:1;">
            <label for="valorVirado">Valor (R$)</label>
            <input id="valorVirado" type="number" step="0.01" placeholder="Ex: 2500" inputmode="decimal">
          </div>

          <div class="field" style="min-width:170px; flex:0;">
            <label>&nbsp;</label>
            <button id="btnAddVirado" style="width:170px;">Adicionar</button>
          </div>
        </div>

        <div class="smallnote">
          * Total e ranking do m√™s calculado
        </div>

        <hr class="sep">

        <h4>üìà Ranking autom√°tico por SDR (m√™s)</h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:70px">#</th>
                <th>SDR</th>
                <th style="width:90px">Clientes</th>
                <th style="width:140px">Faturamento</th>
              </tr>
            </thead>
            <tbody id="rankingVirados"></tbody>
          </table>
        </div>

        <hr class="sep">

        <div class="history-head">
          <h4 style="margin:0;">üìÑ Leads virados do m√™s</h4>
          <div class="pager">
            <button class="btn-secondary mini" id="btnToggleHistorico">Ver hist√≥rico</button>
            <button class="btn-secondary mini" id="btnPrev">‚óÄ</button>
            <div class="count" id="pageInfo">P√°gina 1</div>
            <button class="btn-secondary mini" id="btnNext">‚ñ∂</button>
          </div>
        </div>

        <div class="collapse-wrap" id="historicoWrap">
          <div class="table-wrap" style="margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width:140px">SDR</th>
                  <th style="width:70px">RD</th>
                  <th style="width:110px">Agendou</th>
                  <th style="width:110px">Virou</th>
                  <th style="width:120px">Valor</th>
                  <th style="width:60px"></th>
                </tr>
              </thead>
              <tbody id="listaViradosMes"></tbody>
            </table>
          </div>
        </div>

        <div class="smallnote" id="hintHistorico">Mostrando 5 registros por p√°gina.</div>
      </div>

    </div>
  </div>

  <!-- ‚úÖ VIEW: GEST√ÉO (dashboard simples, sem mudar suas tabelas) -->
  <div class="view" id="viewGestao" role="tabpanel" aria-labelledby="tabGestao">
    <div class="card glass">
      <h2>Dashboard (Gest√£o)</h2>
      

      <div class="dash-grid" style="margin-top:12px;">
        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Faturamento no m√™s</div>
            <div class="value" id="dashFaturamento">‚Äî</div>
            <div class="sub" id="dashFaturamentoSub">Atualiza conforme virados do m√™s</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Clientes no m√™s</div>
            <div class="value" id="dashClientes">‚Äî</div>
            <div class="sub">Total de virados no m√™s</div>
          </div>
        </div>

        <div class="card glass" style="margin:0;">
          <div class="dash-kpi">
            <div class="label">Top SDR (m√™s)</div>
            <div class="value" id="dashTopSdr">‚Äî</div>
            <div class="sub" id="dashTopSdrSub">Por faturamento no m√™s</div>
          </div>
        </div>
      </div>

      <hr class="sep">

      <h4>üìå Ranking (m√™s) ‚Äì vis√£o Gest√£o</h4>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th>SDR</th>
              <th style="width:90px">Clientes</th>
              <th style="width:140px">Faturamento</th>
            </tr>
          </thead>
          <tbody id="dashRankingVirados"></tbody>
        </table>
      </div>

      
    </div>
  </div>

</div>

<script>
const SENHA_ADM = "654321";
let perfil = null;

const supabaseClient = supabase.createClient(
  "https://ugyybmztaoopyetyrsit.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVneXlibXp0YW9vcHlldHlyc2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTczNDQsImV4cCI6MjA4Mzg5MzM0NH0.dLtrsK7XQNwM1DGMo-vv8llqZT5ajLKByfZIKLMOwgg"
);

const $ = (id) => document.getElementById(id);
const badgeStatus = $("badgeStatus");
const toastEl = $("toast");

let inFlight = 0;
function setStatus(txt){
  badgeStatus.innerHTML = `<span class="dot"></span>Status: ${txt}`;
}
function toast(msg){
  toastEl.textContent = msg;
  toastEl.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>toastEl.style.display="none", 2200);
}

/* ‚úÖ CORRE√á√ÉO: supabase retorna "thenable" (query builder) que n√£o tem .finally()
      ent√£o o withLoading n√£o pode usar promise.finally.
      Aqui usamos try/finally com await (funciona com Promise e com thenable). */
async function withLoading(promiseLike){
  inFlight++;
  setStatus("carregando...");
  try{
    return await promiseLike;
  } finally {
    inFlight--;
    if(inFlight<=0) setStatus("pronto");
  }
}

function debounce(fn, ms){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

/* ‚úÖ ABAS: Opera√ß√£o x Gest√£o */
let activeView = "operacao";
function setActiveView(view){
  activeView = view;

  const isOperacao = view === "operacao";
  $("viewOperacao").classList.toggle("active", isOperacao);
  $("viewGestao").classList.toggle("active", !isOperacao);

  $("tabOperacao").classList.toggle("active", isOperacao);
  $("tabGestao").classList.toggle("active", !isOperacao);

  $("tabOperacao").setAttribute("aria-selected", String(isOperacao));
  $("tabGestao").setAttribute("aria-selected", String(!isOperacao));

  $("subtituloView").textContent = isOperacao ? "Opera√ß√£o" : "Gest√£o";

  /* quando entra na gest√£o, atualiza dashboard */
  if (!isOperacao) {
    withLoading(atualizarDashboardGestao());
  }
}

/* acessibilidade: atalhos de teclado nas abas */
function initTabs(){
  const op = $("tabOperacao");
  const ge = $("tabGestao");

  op.addEventListener("click", ()=>setActiveView("operacao"));
  ge.addEventListener("click", ()=>setActiveView("gestao"));

  [op, ge].forEach(btn=>{
    btn.addEventListener("keydown", (e)=>{
      if(e.key==="ArrowLeft" || e.key==="ArrowRight"){
        e.preventDefault();
        if(document.activeElement === op) ge.focus(); else op.focus();
      }
      if(e.key==="Enter" || e.key===" "){
        e.preventDefault();
        btn.click();
      }
    });
  });

  /* estado inicial */
  op.classList.add("active");
  ge.classList.remove("active");
}
initTabs();

/* Hist√≥rico */
const PAGE_SIZE = 5;
let historicoPage = 1;
let historicoTotal = 0;
let historicoOpen = false;

let cacheMonthKey = null;

/* LOGIN */
function entrarSDR() { perfil = "sdr"; iniciar(); }
function entrarADM() {
  const senha = prompt("Digite a senha de administrador:");
  if (senha === SENHA_ADM) { perfil = "admin"; iniciar(); }
  else alert("Senha incorreta");
}

function iniciar() {
  $("login").style.display = "none";
  $("badgePerfil").innerHTML = `<span class="dot"></span>Perfil: ${perfil === "admin" ? "ADM" : "SDR"}`;

  /* ‚úÖ regra: SDR n√£o acessa Gest√£o (voc√™ pode liberar depois se quiser) */
  if (perfil !== "admin") {
    document.querySelectorAll(".admin-only").forEach(b => b.remove());
    $("tabGestao").disabled = true;
    $("tabGestao").style.opacity = ".55";
    $("tabGestao").style.cursor = "not-allowed";
    setActiveView("operacao");
  } else {
    $("tabGestao").disabled = false;
  }

  carregar();
}

/* RANKINGS */
const nomeInput = $("nome");
const qtdInput = $("qtd");
$("btnAdd").onclick = () => withLoading(adicionar());

async function adicionar() {
  const nome = nomeInput.value.trim();
  const qtd = Number(qtdInput.value);
  if (!nome || qtd <= 0) return alert("Preencha corretamente");

  const { data, error: selErr } = await supabaseClient
    .from("ranking")
    .select("id,nome,leads_dia,leads_semana,leads_mes")
    .eq("nome", nome)
    .maybeSingle();

  if (selErr) return alert("Erro ao buscar: " + (selErr.message || ""));

  if (data) {
    const { error } = await supabaseClient.from("ranking").update({
      leads_dia: (data.leads_dia || 0) + qtd,
      leads_semana: (data.leads_semana || 0) + qtd,
      leads_mes: (data.leads_mes || 0) + qtd
    }).eq("id", data.id);
    if (error) return alert("Erro ao atualizar: " + (error.message || ""));
  } else {
    const { error } = await supabaseClient.from("ranking").insert({
      nome, leads_dia: qtd, leads_semana: qtd, leads_mes: qtd
    });
    if (error) return alert("Erro ao inserir: " + (error.message || ""));
  }

  nomeInput.value = "";
  qtdInput.value = "";
  await carregarRanking();
  if (perfil === "admin") await atualizarDashboardGestao();
  toast("Lead adicionado");
}

function linha(p, i, campo) {
  const medalha = i === 0 ? "ü•á" : i === 1 ? "ü•à" : i === 2 ? "ü•â" : "";
  return `
  <tr data-id="${p.id}" class="${i < 3 ? `top${i+1}` : ""}">
    <td style="width:70px">${medalha} ${i + 1}</td>
    <td contenteditable class="editable">${p.nome}</td>
    <td style="width:70px; font-weight:900;">${p[campo] || 0}</td>
    ${perfil === "admin" ? `<td style="width:60px"><button class="remove" type="button">X</button></td>` : ""}
  </tr>`;
}

async function carregarRanking() {
  const { data, error } = await supabaseClient
    .from("ranking")
    .select("id,nome,leads_dia,leads_semana,leads_mes");

  if (error || !data) {
    console.error(error);
    return;
  }

  const filtrado = (Array.isArray(data) ? data : []).filter(p => !String(p.nome || "").startsWith("__REMOVIDO__"));

  render("Dia", "leads_dia", filtrado);
  render("Semana", "leads_semana", filtrado);
  render("Mes", "leads_mes", filtrado);
}

function render(tipo, campo, data) {
  $("ranking" + tipo).innerHTML =
    [...data]
      .sort((a, b) => (b[campo] || 0) - (a[campo] || 0))
      .map((p, i) => linha(p, i, campo))
      .join("");
}

async function resetar(tipo) {
  if (perfil !== "admin") return;

  const payload =
    tipo === "dia" ? { leads_dia: 0 } :
    tipo === "semana" ? { leads_semana: 0 } :
    tipo === "mes" ? { leads_mes: 0 } : null;

  if (!payload) return;

  const { error } = await withLoading(
    supabaseClient
      .from("ranking")
      .update(payload)
      .not("id", "is", null)
  );

  if (error) {
    alert("Erro ao resetar: " + (error.message || ""));
    return;
  }

  await withLoading(carregarRanking());
  toast("Ranking resetado");
}

/* ‚úÖ EXCLUIR (ranking) com fallback */
document.addEventListener("click", async e => {
  if (!e.target || !e.target.classList) return;
  if (e.target.classList.contains("removeVirado")) return;

  if (e.target.classList.contains("remove")) {
    if (perfil !== "admin") return;

    const tr = e.target.closest("tr");
    if (!tr) return;
    const id = tr.dataset.id;

    const { error } = await withLoading(supabaseClient.from("ranking").delete().eq("id", id));

    if (error) {
      const { error: uerr } = await withLoading(
        supabaseClient
          .from("ranking")
          .update({ nome: `__REMOVIDO__${id}`, leads_dia: 0, leads_semana: 0, leads_mes: 0 })
          .eq("id", id)
      );
      if (uerr) {
        alert("Erro ao excluir: " + (uerr.message || error.message || ""));
        return;
      }
    }

    await withLoading(carregarRanking());
    toast("Removido");
  }
});

const atualizarNomeDebounced = debounce(async (id, nome) => {
  const { error } = await withLoading(supabaseClient.from("ranking").update({ nome }).eq("id", id));
  if (error) {
    alert("Erro ao atualizar nome: " + (error.message || ""));
    return;
  }
  await withLoading(carregarRanking());
  toast("Nome atualizado");
}, 250);

document.addEventListener("blur", async e => {
  if (e.target.classList && e.target.classList.contains("editable")) {
    const tr = e.target.closest("tr");
    const id = tr?.dataset?.id;
    const novo = (e.target.innerText || "").trim();
    if (!id || !novo) return;
    if (novo.startsWith("__REMOVIDO__")) return;
    atualizarNomeDebounced(id, novo);
  }
}, true);

/* LEADS VIRADOS */
const sdrViradoInput = $("sdrVirado");
const linkRdViradoInput = $("linkRdVirado");
const dataAgendouInput = $("dataAgendou");
const dataVirouInput = $("dataVirou");
const valorViradoInput = $("valorVirado");
const totalMesBox = $("totalMesBox");
const kpiClientes = $("kpiClientes");

$("btnAddVirado").onclick = () => withLoading(adicionarVirado());

$("btnToggleHistorico").onclick = () => {
  historicoOpen = !historicoOpen;
  $("historicoWrap").classList.toggle("open", historicoOpen);
  $("btnToggleHistorico").innerText = historicoOpen ? "Ocultar hist√≥rico" : "Ver hist√≥rico";
  if (historicoOpen) withLoading(carregarViradosPagina());
};

$("btnPrev").onclick = () => {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  historicoPage = Math.max(1, historicoPage - 1);
  if (historicoPage > totalPages) historicoPage = totalPages;
  withLoading(carregarViradosPagina());
};

$("btnNext").onclick = () => {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  historicoPage = Math.min(totalPages, historicoPage + 1);
  withLoading(carregarViradosPagina());
};

function normalizarLink(url) {
  const u = (url || "").trim();
  if (!u) return "";
  if (u.startsWith("http://") || u.startsWith("https://")) return u;
  return "https://" + u;
}
function fmtBRL(v) {
  const n = Number(v || 0);
  return new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(n);
}
function mesAnoAtualLabel() {
  const d = new Date();
  return d.toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
}
function getMesRangeISO() {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 1);
  return { startISO: start.toISOString().slice(0, 10), endISO: end.toISOString().slice(0, 10) };
}
function monthKey() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
}

async function adicionarVirado() {
  try{
    const sdr = (sdrViradoInput.value || "").trim();
    const link_rd = normalizarLink(linkRdViradoInput.value);

    const data_virou = (dataVirouInput.value || "").trim();

    const data_agendou = dataAgendouInput
      ? ((dataAgendouInput.value || "").trim() || data_virou)
      : data_virou;

    const valor = Number(valorViradoInput.value);

    if (!sdr) return alert("Preencha o Nome do SDR");
    if (!data_virou) return alert("Preencha a Data que virou cliente");
    if (!valor || valor <= 0) return alert("Preencha o Valor (R$) corretamente");

    const { error } = await supabaseClient
      .from("leads_virados")
      .insert({ sdr, link_rd, data_agendou, data_virou, valor });

    if (error) return alert("Erro ao adicionar: " + (error.message || "Tente novamente"));

    sdrViradoInput.value = "";
    linkRdViradoInput.value = "";
    if (dataAgendouInput) dataAgendouInput.value = "";
    dataVirouInput.value = "";
    valorViradoInput.value = "";

    historicoPage = 1;
    cacheMonthKey = null;
    await carregarViradosResumo();
    if (historicoOpen) await carregarViradosPagina();

    if (perfil === "admin") await atualizarDashboardGestao();

    toast("Virado adicionado");
  }catch(err){
    alert("Erro no bot√£o Adicionar (virados): " + (err?.message || err));
  }
}

async function carregarViradosResumo() {
  const key = monthKey();
  if (cacheMonthKey === key && window.__viradosResumoCache) {
    aplicarResumo(window.__viradosResumoCache);
    return;
  }

  const { startISO, endISO } = getMesRangeISO();
  const { data, error } = await supabaseClient
    .from("leads_virados")
    .select("id,sdr,valor,data_virou")
    .gte("data_virou", startISO)
    .lt("data_virou", endISO);

  if (error) {
    totalMesBox.innerHTML = `<span class="kpiDot"></span>Total faturado: <strong style="color:#ffd6d6">Erro</strong>`;
    kpiClientes.innerHTML = `<span class="kpiDot"></span>Clientes: <strong style="color:#ffd6d6">Erro</strong>`;
    $("rankingVirados").innerHTML = "";
    historicoTotal = 0;
    atualizarPaginacao();
    return;
  }

  const viradosMes = Array.isArray(data) ? data : [];
  window.__viradosResumoCache = viradosMes;
  cacheMonthKey = key;
  aplicarResumo(viradosMes);

  historicoTotal = viradosMes.length;
  atualizarPaginacao();
}

function aplicarResumo(viradosMes) {
  let totalMes = 0;
  const map = {};
  for (const v of viradosMes) {
    const val = Number(v.valor || 0);
    totalMes += val;
    const sdr = (v.sdr || "").trim() || "Sem SDR";
    if (!map[sdr]) map[sdr] = { sdr, qtd: 0, total: 0 };
    map[sdr].qtd += 1;
    map[sdr].total += val;
  }

  const ranking = Object.values(map).sort((a, b) => (b.total || 0) - (a.total || 0));
  totalMesBox.innerHTML = `<span class="kpiDot"></span>Total faturado (${mesAnoAtualLabel()}): <strong>${fmtBRL(totalMes)}</strong>`;
  kpiClientes.innerHTML = `<span class="kpiDot"></span>Clientes: <strong>${viradosMes.length}</strong>`;

  $("rankingVirados").innerHTML =
    ranking.length
      ? ranking.map((it, i) => `
        <tr class="${i<3?`top${i+1}`:""}">
          <td style="width:70px">${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""} ${i+1}</td>
          <td>${it.sdr}</td>
          <td style="width:90px; font-weight:900;">${it.qtd}</td>
          <td style="width:140px; font-weight:900;">${fmtBRL(it.total)}</td>
        </tr>`).join("")
      : `<tr><td colspan="4" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros no m√™s.</td></tr>`;
}

async function carregarViradosPagina() {
  const { startISO, endISO } = getMesRangeISO();

  const from = (historicoPage - 1) * PAGE_SIZE;
  const to = from + PAGE_SIZE - 1;

  const { data, error, count } = await supabaseClient
    .from("leads_virados")
    .select("id,sdr,link_rd,data_agendou,data_virou,valor", { count: "exact" })
    .gte("data_virou", startISO)
    .lt("data_virou", endISO)
    .order("data_virou", { ascending: false })
    .range(from, to);

  if (typeof count === "number") historicoTotal = count;

  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  if (historicoPage > totalPages) historicoPage = totalPages;
  if (historicoPage < 1) historicoPage = 1;

  if (error) {
    $("listaViradosMes").innerHTML = `<tr><td colspan="6" style="padding:12px; color:rgba(238,242,255,.60);">Erro ao carregar hist√≥rico.</td></tr>`;
    atualizarPaginacao();
    return;
  }

  const pageItems = Array.isArray(data) ? data : [];
  $("listaViradosMes").innerHTML =
    pageItems.length
      ? pageItems.map(v => {
          const link = v.link_rd ? `<a class="rdlink" href="${v.link_rd}" target="_blank" rel="noopener noreferrer">Abrir</a>` : "";
          const btn = (perfil === "admin") ? `<button class="remove removeVirado" type="button">X</button>` : "";
          return `
            <tr data-id="${v.id}">
              <td>${v.sdr || ""}</td>
              <td>${link}</td>
              <td>${v.data_agendou ? String(v.data_agendou) : ""}</td>
              <td>${v.data_virou ? String(v.data_virou) : ""}</td>
              <td style="font-weight:900;">${fmtBRL(v.valor || 0)}</td>
              <td>${btn}</td>
            </tr>`;
        }).join("")
      : `<tr><td colspan="6" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros.</td></tr>`;

  atualizarPaginacao();
}

function atualizarPaginacao() {
  const totalPages = Math.max(1, Math.ceil((historicoTotal || 0) / PAGE_SIZE));
  $("pageInfo").innerText = `P√°gina ${historicoPage} de ${totalPages}`;
  $("btnPrev").disabled = (historicoPage <= 1);
  $("btnNext").disabled = (historicoPage >= totalPages);
  $("hintHistorico").style.display = historicoTotal > 0 ? "block" : "none";
}

document.addEventListener("click", async e => {
  if (e.target.classList && e.target.classList.contains("removeVirado")) {
    if (perfil !== "admin") return;

    const id = e.target.closest("tr")?.dataset?.id;
    if (!id) return;

    const { error } = await withLoading(supabaseClient.from("leads_virados").delete().eq("id", id));

    if (error) {
      const { error: uerr } = await withLoading(
        supabaseClient
          .from("leads_virados")
          .update({
            sdr: `__REMOVIDO__${id}`,
            valor: 0,
            data_virou: "1900-01-01",
            data_agendou: "1900-01-01"
          })
          .eq("id", id)
      );
      if (uerr) {
        alert("Erro ao remover virado: " + (uerr.message || error.message || ""));
        return;
      }
    }

    cacheMonthKey = null;
    await withLoading(carregarViradosResumo());
    if (historicoOpen) await withLoading(carregarViradosPagina());

    if (perfil === "admin") await atualizarDashboardGestao();

    toast("Removido");
  }
});

/* ‚úÖ Dashboard Gest√£o: reaproveita o cache do resumo do m√™s */
async function atualizarDashboardGestao(){
  /* garante resumo carregado */
  if (!window.__viradosResumoCache || cacheMonthKey !== monthKey()){
    await carregarViradosResumo();
  }

  const viradosMes = Array.isArray(window.__viradosResumoCache) ? window.__viradosResumoCache : [];

  let totalMes = 0;
  const map = {};
  for (const v of viradosMes) {
    const val = Number(v.valor || 0);
    totalMes += val;
    const sdr = (v.sdr || "").trim() || "Sem SDR";
    if (!map[sdr]) map[sdr] = { sdr, qtd: 0, total: 0 };
    map[sdr].qtd += 1;
    map[sdr].total += val;
  }
  const ranking = Object.values(map).sort((a,b)=> (b.total||0)-(a.total||0));

  $("dashFaturamento").textContent = fmtBRL(totalMes);
  $("dashClientes").textContent = String(viradosMes.length);

  const top = ranking[0];
  $("dashTopSdr").textContent = top ? top.sdr : "‚Äî";
  $("dashTopSdrSub").textContent = top ? `${fmtBRL(top.total)} ‚Ä¢ ${top.qtd} cliente(s)` : "Por faturamento no m√™s";

  $("dashRankingVirados").innerHTML =
    ranking.length
      ? ranking.map((it, i) => `
        <tr class="${i<3?`top${i+1}`:""}">
          <td style="width:70px">${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""} ${i+1}</td>
          <td>${it.sdr}</td>
          <td style="width:90px; font-weight:900;">${it.qtd}</td>
          <td style="width:140px; font-weight:900;">${fmtBRL(it.total)}</td>
        </tr>`).join("")
      : `<tr><td colspan="4" style="padding:12px; color:rgba(238,242,255,.60);">Sem registros no m√™s.</td></tr>`;
}

/* BOOT */
async function carregar() {
  await withLoading(carregarRanking());
  await withLoading(carregarViradosResumo());
  if (perfil === "admin" && activeView === "gestao") await withLoading(atualizarDashboardGestao());
}

/* Enter */
nomeInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAdd").click(); });
qtdInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAdd").click(); });
sdrViradoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAddVirado").click(); });
valorViradoInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("btnAddVirado").click(); });
</script>
</body>
</html>

